#!/bin/bash

# CVE-2021-22205 (GitLab DjVu File Upload RCE) WAF Protection Script
# Description: GitLab DjVu file upload leading to Remote Code Execution
# CVE: CVE-2021-22205
# Severity: Critical (CVSS 10.0)

# Load configuration and common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../config/global.conf"
source "$SCRIPT_DIR/../utils/common.sh"

# CVE-specific configuration
CVE_NAME="CVE-2021-22205"
CONTAINER_NAME="${GITLAB_CONTAINER_NAME}"
WAF_CONTAINER_NAME="${GITLAB_WAF_CONTAINER_NAME}"
APP_PORT="${GITLAB_APP_PORT}"
WAF_PORT="${GITLAB_WAF_PORT}"
NETWORK_NAME="${GITLAB_NETWORK_NAME}"
PROJECT_DIR="${CVE_NAME,,}_protection"

# Initialize
init_script "$CVE_NAME" "$PROJECT_DIR"

# Main menu
show_main_menu() {
    clear
    show_banner "GitLab DjVu RCE Protection (CVE-2021-22205)"
    
    echo -e "${CYAN}é€‰æ‹©æ“ä½œæ¨¡å¼:${NC}"
    echo -e "${WHITE}1.${NC} ç”Ÿæˆé˜²æŠ¤è„šæœ¬"
    echo -e "${WHITE}2.${NC} éƒ¨ç½² WAF é˜²æŠ¤"
    echo -e "${WHITE}3.${NC} ç”Ÿæˆæµ‹è¯•è„šæœ¬"
    echo -e "${WHITE}4.${NC} ç›‘æ§ WAF çŠ¶æ€"
    echo -e "${WHITE}5.${NC} æŸ¥çœ‹WAFæ—¥å¿—"
    echo -e "${WHITE}6.${NC} ç”Ÿæˆæ¸…ç†è„šæœ¬"
    echo -e "${WHITE}7.${NC} æ¸…ç†ç¯å¢ƒ"
    echo -e "${WHITE}0.${NC} é€€å‡º"
    echo ""
}

# Generate deployment script
generate_deployment_script() {
    local deploy_script="$PROJECT_DIR/deploy.sh"
    
    log_info "ç”Ÿæˆéƒ¨ç½²è„šæœ¬: $deploy_script"
    
    cat > "$deploy_script" << 'EOF'
#!/bin/bash

# GitLab CVE-2021-22205 WAF Protection Deployment Script
# Auto-generated deployment script

source ../utils/common.sh

# Configuration
CVE_NAME="CVE-2021-22205"
CONTAINER_NAME="gitlab_vulnerable_cve22205"
WAF_CONTAINER_NAME="gitlab_waf_cve22205"
APP_PORT=80
WAF_PORT=8085
NETWORK_NAME="gitlab_cve22205_net"

deploy_protection() {
    show_banner "Deploying GitLab DjVu RCE Protection"
    
    # Create directory structure
    log_info "åˆ›å»ºç›®å½•ç»“æ„..."
    mkdir -p waf_config/rules waf_logs templates
    
    # Generate docker-compose.yml
    log_info "ç”Ÿæˆ Docker Compose é…ç½®..."
    cat > docker-compose.yml << COMPOSE_EOF
version: '3.8'

services:
  gitlab_app:
    image: vulfocus/gitlab-cve_2021_22205:latest
    container_name: ${CONTAINER_NAME}
    networks:
      - ${NETWORK_NAME}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/users/sign_in"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  waf:
    image: owasp/modsecurity:apache
    container_name: ${WAF_CONTAINER_NAME}
    ports:
      - "${WAF_PORT}:80"
    networks:
      - ${NETWORK_NAME}
    environment:
      - BACKEND=http://gitlab_app:${APP_PORT}
      - LOGLEVEL=info
      - PROXY_ERROR_OVERRIDE=On
      - PROXY_TIMEOUT=300
    volumes:
      - ./waf_config/modsecurity.conf:/etc/modsecurity/modsecurity.conf:ro
      - ./waf_config/rules:/etc/modsecurity.d/rules:ro
      - ./waf_logs:/var/log/apache2
      - ./waf_config/htaccess.conf:/etc/apache2/conf-available/security.conf:ro
    depends_on:
      gitlab_app:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  ${NETWORK_NAME}:
    driver: bridge

COMPOSE_EOF

    # Generate ModSecurity configuration
    log_info "ç”Ÿæˆ ModSecurity é…ç½®..."
    cat > waf_config/modsecurity.conf << MODSEC_EOF
# ModSecurity Configuration for GitLab CVE-2021-22205 Protection
SecRuleEngine On
SecRequestBodyAccess On
SecRequestBodyLimit 52428800
SecRequestBodyNoFilesLimit 1048576
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogType Serial
SecAuditLog /var/log/apache2/modsec_audit.log
SecAuditLogFormat JSON
SecAuditLogParts ABIJDEFHZ
SecAuditLogRelevantStatus "^(?:5|4(?!04))"

# File upload handling
SecTmpDir /tmp/
SecUploadDir /tmp/
SecUploadKeepFiles Off
SecUploadFileLimit 10
SecUploadFileLimitAction Reject

# Debug logging
SecDebugLog /var/log/apache2/modsec_debug.log
SecDebugLogLevel 3

# Response headers
SecServerSignature "Apache/2.4.41"
SecComponentSignature "ModSecurity for Apache/2.9.3"

# Include custom rules
Include /etc/modsecurity.d/rules/cve-2021-22205-rules.conf
Include /etc/modsecurity.d/rules/file-upload-protection.conf
Include /etc/modsecurity.d/rules/rce-protection.conf

MODSEC_EOF

    # Generate DjVu-specific protection rules
    log_info "ç”Ÿæˆ DjVu æ”»å‡»é˜²æŠ¤è§„åˆ™..."
    cat > waf_config/rules/cve-2021-22205-rules.conf << RULES_EOF
# CVE-2021-22205 GitLab DjVu RCE Protection Rules

# Rule 2210: Block DjVu files with suspicious headers
SecRule FILES_TMPNAMES "@inspectFile /tmp/detect_djvu.lua" \\
    "id:2210,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'CVE-2021-22205: Malicious DjVu file detected',\\
    logdata:'File: %{MATCHED_VAR_NAME}',\\
    tag:'cve-2021-22205',\\
    tag:'file-upload',\\
    tag:'rce',\\
    severity:'CRITICAL'"

# Rule 2211: Detect DjVu magic bytes with suspicious content
SecRule REQUEST_BODY "@rx (?:AT&TFORM|DjVu)[\\s\\S]{0,1000}(?:qx|\\x60|system|exec|perl\\s+-e|sh\\s+-c|bash\\s+-c)" \\
    "id:2211,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'CVE-2021-22205: DjVu file with embedded RCE payload',\\
    logdata:'Suspicious content detected in uploaded file',\\
    tag:'cve-2021-22205',\\
    tag:'djvu-rce',\\
    severity:'CRITICAL'"

# Rule 2212: Block files with DjVu structure and Perl commands
SecRule REQUEST_BODY "@rx DJVIANTa[^\\n\\r]*?\\s\\.\\s*['\"]?\\s*(?:qx|\\x60|system|exec)" \\
    "id:2212,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'CVE-2021-22205: DjVu file with Perl command injection',\\
    logdata:'Perl command injection pattern detected',\\
    tag:'cve-2021-22205',\\
    tag:'perl-injection',\\
    severity:'CRITICAL'"

# Rule 2213: Enhanced file upload validation for image files
SecRule FILES_NAMES "@rx \\.(jpe?g|png|gif|tiff?|djvu)$" \\
    "chain,\\
    id:2213,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'CVE-2021-22205: Suspicious image file upload',\\
    tag:'cve-2021-22205'"
    SecRule REQUEST_BODY "@rx (?:AT&TFORM|DjVu|DJVM)" \\
        "chain,\\
        msg:'DjVu content in image file'"
        SecRule REQUEST_BODY "@rx (?:whoami|id|uname|cat\\s+/etc/passwd|nc\\s|perl\\s+-e|sh\\s+-c|bash\\s+-c|wget\\s|curl\\s|\\x60|system\\(|qx\\{)" \\
            "msg:'RCE payload in DjVu file'"

# Rule 2214: Block GitLab-specific vulnerable endpoints
SecRule REQUEST_URI "@rx /uploads/user/" \\
    "chain,\\
    id:2214,\\
    phase:1,\\
    block,\\
    log,\\
    msg:'CVE-2021-22205: Blocked upload to vulnerable GitLab endpoint',\\
    tag:'cve-2021-22205'"
    SecRule REQUEST_METHOD "@streq POST"

# Rule 2215: Rate limiting for file uploads
SecAction "id:2215,\\
    phase:1,\\
    nolog,\\
    initcol:ip=%{REMOTE_ADDR},\\
    setvar:ip.upload_counter=+1,\\
    expirevar:ip.upload_counter=300"

SecRule IP:UPLOAD_COUNTER "@gt 10" \\
    "id:2216,\\
    phase:1,\\
    block,\\
    log,\\
    msg:'CVE-2021-22205: File upload rate limit exceeded',\\
    logdata:'Upload attempts: %{ip.upload_counter}',\\
    tag:'rate-limiting'"

RULES_EOF

    # Generate file upload protection rules
    cat > waf_config/rules/file-upload-protection.conf << UPLOAD_EOF
# Enhanced File Upload Protection

# Rule 2220: File size validation
SecRule FILES_SIZES "@gt 10485760" \\
    "id:2220,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'File upload: File too large',\\
    tag:'file-upload-protection'"

# Rule 2221: File extension whitelist
SecRule FILES_NAMES "!@rx \\.(jpg|jpeg|png|gif|pdf|txt|doc|docx|xls|xlsx|ppt|pptx)$" \\
    "id:2221,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'File upload: Dangerous file extension',\\
    logdata:'Filename: %{MATCHED_VAR}',\\
    tag:'file-upload-protection'"

# Rule 2222: MIME type validation
SecRule FILES_TMPNAMES "@inspectFile /tmp/validate_mime.lua" \\
    "id:2222,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'File upload: MIME type mismatch',\\
    tag:'file-upload-protection'"

UPLOAD_EOF

    # Generate RCE protection rules
    cat > waf_config/rules/rce-protection.conf << RCE_EOF
# Remote Code Execution Protection

# Rule 2230: Command injection patterns
SecRule ARGS "@rx (?:;|\\||&|\\$\\(|\\`|<|>|\\{|\\})" \\
    "id:2230,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'RCE Protection: Command injection attempt',\\
    logdata:'Pattern: %{MATCHED_VAR}',\\
    tag:'rce-protection',\\
    transform:'lowercase'"

# Rule 2231: System command detection
SecRule ARGS "@rx (?:whoami|id|uname|cat|ls|ps|netstat|ifconfig|ping|wget|curl|nc|telnet)" \\
    "id:2231,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'RCE Protection: System command detected',\\
    logdata:'Command: %{MATCHED_VAR}',\\
    tag:'rce-protection',\\
    transform:'lowercase'"

# Rule 2232: Script interpreter detection
SecRule ARGS "@rx (?:perl|python|php|ruby|bash|sh|cmd|powershell)" \\
    "id:2232,\\
    phase:2,\\
    block,\\
    log,\\
    msg:'RCE Protection: Script interpreter detected',\\
    logdata:'Interpreter: %{MATCHED_VAR}',\\
    tag:'rce-protection',\\
    transform:'lowercase'"

RCE_EOF

    # Generate Apache security configuration
    cat > waf_config/htaccess.conf << APACHE_EOF
# Apache Security Configuration
ServerTokens Prod
ServerSignature Off

# Security headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
Header always set Content-Security-Policy "default-src 'self'"

# Hide Apache version
ServerName "Security Server"

APACHE_EOF

    # Create log files
    log_info "åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶..."
    touch waf_logs/access.log waf_logs/error.log waf_logs/modsec_audit.log waf_logs/modsec_debug.log

    # Generate monitoring dashboard
    generate_monitoring_dashboard

    # Deploy containers
    log_info "å¯åŠ¨ Docker å®¹å™¨..."
    docker_compose_up

    if [ $? -eq 0 ]; then
        log_success "GitLab CVE-2021-22205 é˜²æŠ¤éƒ¨ç½²æˆåŠŸ!"
        echo -e "${CYAN}è®¿é—®ä¿¡æ¯:${NC}"
        echo -e "  WAF åœ°å€: http://localhost:${WAF_PORT}"
        echo -e "  ç›‘æ§é¢æ¿: file://$(pwd)/monitoring/dashboard.html"
        echo -e "${YELLOW}æ³¨æ„: GitLab é¦–æ¬¡å¯åŠ¨éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´${NC}"
    else
        log_error "éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Docker ç¯å¢ƒ"
        return 1
    fi
}

generate_monitoring_dashboard() {
    mkdir -p monitoring
    cat > monitoring/dashboard.html << HTML_EOF
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab CVE-2021-22205 WAF ç›‘æ§é¢æ¿</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-good { color: #27ae60; }
        .status-warning { color: #f39c12; }
        .status-critical { color: #e74c3c; }
        .metric { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        .log-container { max-height: 300px; overflow-y: auto; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; font-family: monospace; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2980b9; }
        .refresh-btn { float: right; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ GitLab CVE-2021-22205 WAF é˜²æŠ¤ç›‘æ§</h1>
            <p>å®æ—¶ç›‘æ§ GitLab DjVu æ–‡ä»¶ä¸Šä¼  RCE é˜²æŠ¤çŠ¶æ€</p>
            <button class="refresh-btn" onclick="refreshAll()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>ğŸš€ æœåŠ¡çŠ¶æ€</h3>
                <div class="metric">
                    <span>GitLab åº”ç”¨:</span>
                    <span id="gitlab-status" class="status-good">è¿è¡Œä¸­</span>
                </div>
                <div class="metric">
                    <span>WAF æœåŠ¡:</span>
                    <span id="waf-status" class="status-good">æ´»è·ƒ</span>
                </div>
                <div class="metric">
                    <span>é˜²æŠ¤è§„åˆ™:</span>
                    <span id="rules-count">6 æ¡è§„åˆ™</span>
                </div>
                <button onclick="checkServices()">æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
            </div>

            <div class="card">
                <h3>ğŸ“Š æ”»å‡»ç»Ÿè®¡</h3>
                <div class="metric">
                    <span>DjVu æ”»å‡»é˜»æ­¢:</span>
                    <span id="djvu-blocks" class="status-warning">0</span>
                </div>
                <div class="metric">
                    <span>RCE å°è¯•é˜»æ­¢:</span>
                    <span id="rce-blocks" class="status-warning">0</span>
                </div>
                <div class="metric">
                    <span>æ–‡ä»¶ä¸Šä¼ æ‹¦æˆª:</span>
                    <span id="upload-blocks" class="status-warning">0</span>
                </div>
                <div class="metric">
                    <span>æ€»è¯·æ±‚æ•°:</span>
                    <span id="total-requests">0</span>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ” æœ€æ–°æ—¥å¿—</h3>
                <div class="log-container" id="recent-logs">
                    <div>ç­‰å¾…æ—¥å¿—æ•°æ®...</div>
                </div>
                <button onclick="loadLogs()">åˆ·æ–°æ—¥å¿—</button>
                <button onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
            </div>

            <div class="card">
                <h3>âš™ï¸ å¿«é€Ÿæ“ä½œ</h3>
                <button onclick="testWAF()">æµ‹è¯• WAF</button>
                <button onclick="updateRules()">æ›´æ–°è§„åˆ™</button>
                <button onclick="restartWAF()">é‡å¯ WAF</button>
                <button onclick="viewFullLogs()">æŸ¥çœ‹å®Œæ•´æ—¥å¿—</button>
            </div>
        </div>
    </div>

    <script>
        function refreshAll() {
            checkServices();
            loadLogs();
            updateStats();
        }

        function checkServices() {
            // æ¨¡æ‹Ÿæ£€æŸ¥æœåŠ¡çŠ¶æ€
            console.log('æ£€æŸ¥æœåŠ¡çŠ¶æ€...');
            document.getElementById('gitlab-status').textContent = 'è¿è¡Œä¸­';
            document.getElementById('waf-status').textContent = 'æ´»è·ƒ';
        }

        function loadLogs() {
            const logs = [
                '[' + new Date().toLocaleString() + '] ModSecurity: è§„åˆ™å¼•æ“å·²å¯åŠ¨',
                '[' + new Date().toLocaleString() + '] WAF: ç›‘å¬ç«¯å£ ${WAF_PORT}',
                '[' + new Date().toLocaleString() + '] é˜²æŠ¤: CVE-2021-22205 è§„åˆ™å·²åŠ è½½',
            ];
            document.getElementById('recent-logs').innerHTML = logs.map(log => '<div>' + log + '</div>').join('');
        }

        function updateStats() {
            // æ¨¡æ‹Ÿæ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('djvu-blocks').textContent = Math.floor(Math.random() * 10);
            document.getElementById('rce-blocks').textContent = Math.floor(Math.random() * 5);
            document.getElementById('upload-blocks').textContent = Math.floor(Math.random() * 15);
            document.getElementById('total-requests').textContent = Math.floor(Math.random() * 1000);
        }

        function testWAF() {
            alert('WAF æµ‹è¯•åŠŸèƒ½ - è¯·ä½¿ç”¨æµ‹è¯•è„šæœ¬è¿›è¡Œå®Œæ•´æµ‹è¯•');
        }

        function updateRules() {
            alert('è§„åˆ™æ›´æ–°åŠŸèƒ½ - å°†é‡æ–°åŠ è½½ ModSecurity è§„åˆ™');
        }

        function restartWAF() {
            if(confirm('ç¡®å®šè¦é‡å¯ WAF æœåŠ¡å—ï¼Ÿ')) {
                alert('WAF æœåŠ¡é‡å¯ä¸­...');
            }
        }

        function viewFullLogs() {
            window.open('about:blank').document.write('<pre>' + 
                'å®Œæ•´çš„ WAF æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...\n' +
                'è¯·ä½¿ç”¨: docker logs ${WAF_CONTAINER_NAME}\n' +
                'æˆ–æŸ¥çœ‹: ./waf_logs/ ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶'
            + '</pre>');
        }

        function exportLogs() {
            alert('æ—¥å¿—å¯¼å‡ºåŠŸèƒ½ - æ—¥å¿—æ–‡ä»¶ä½äº ./waf_logs/ ç›®å½•');
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            loadLogs();
            updateStats();
            setInterval(updateStats, 10000); // æ¯10ç§’æ›´æ–°ç»Ÿè®¡
        };
    </script>
</body>
</html>
HTML_EOF
}

# Deploy protection
deploy_protection
EOF

    chmod +x "$deploy_script"
    log_success "éƒ¨ç½²è„šæœ¬å·²ç”Ÿæˆ: $deploy_script"
}

# Generate test script
generate_test_script() {
    local test_script="$PROJECT_DIR/test_cve_2021_22205.sh"
    
    log_info "ç”Ÿæˆæµ‹è¯•è„šæœ¬: $test_script"
    
    cat > "$test_script" << 'EOF'
#!/bin/bash

# CVE-2021-22205 GitLab DjVu RCE Test Script
# Tests WAF protection against DjVu file upload attacks

source ../utils/common.sh

CVE_NAME="CVE-2021-22205"
WAF_URL="http://localhost:8085"
CONTAINER_NAME="gitlab_waf_cve22205"

test_djvu_protection() {
    show_banner "Testing GitLab CVE-2021-22205 Protection"
    
    local test_results=()
    local total_tests=0
    local passed_tests=0
    
    echo -e "${CYAN}å¼€å§‹ WAF é˜²æŠ¤æµ‹è¯•...${NC}"
    
    # Test 1: Basic DjVu file upload
    echo -e "\n${YELLOW}æµ‹è¯• 1: åŸºç¡€ DjVu æ–‡ä»¶ä¸Šä¼ æ£€æµ‹${NC}"
    total_tests=$((total_tests + 1))
    
    # Create malicious DjVu file
    cat > /tmp/malicious.djvu << DJVU_EOF
AT&TFORM0000DJVM
DJVM
AT&TFORM0000DJVU
Sjbz
BGjp
. qx{whoami}
DJVU_EOF
    
    response=$(curl -s -w "%{http_code}" -F "avatar=@/tmp/malicious.djvu" "$WAF_URL/api/v4/user" -o /dev/null)
    if [ "$response" = "403" ]; then
        echo -e "${GREEN}âœ“ åŸºç¡€ DjVu æ”»å‡»å·²è¢«é˜»æ­¢${NC}"
        test_results+=("âœ“ Test 1: DjVu upload blocked")
        passed_tests=$((passed_tests + 1))
    else
        echo -e "${RED}âœ— åŸºç¡€ DjVu æ”»å‡»æœªè¢«é˜»æ­¢ (HTTP $response)${NC}"
        test_results+=("âœ— Test 1: DjVu upload not blocked")
    fi
    
    # Test 2: DjVu with command injection
    echo -e "\n${YELLOW}æµ‹è¯• 2: DjVu å‘½ä»¤æ³¨å…¥æ£€æµ‹${NC}"
    total_tests=$((total_tests + 1))
    
    cat > /tmp/cmd_injection.djvu << DJVU_EOF
DJVIANTa
. 'qx{cat /etc/passwd}'
DJVU_EOF
    
    response=$(curl -s -w "%{http_code}" -F "file=@/tmp/cmd_injection.djvu" "$WAF_URL/uploads/user/" -o /dev/null)
    if [ "$response" = "403" ]; then
        echo -e "${GREEN}âœ“ DjVu å‘½ä»¤æ³¨å…¥å·²è¢«é˜»æ­¢${NC}"
        test_results+=("âœ“ Test 2: Command injection blocked")
        passed_tests=$((passed_tests + 1))
    else
        echo -e "${RED}âœ— DjVu å‘½ä»¤æ³¨å…¥æœªè¢«é˜»æ­¢ (HTTP $response)${NC}"
        test_results+=("âœ— Test 2: Command injection not blocked")
    fi
    
    # Test 3: Image file with DjVu content
    echo -e "\n${YELLOW}æµ‹è¯• 3: ä¼ªè£…å›¾ç‰‡æ–‡ä»¶æ£€æµ‹${NC}"
    total_tests=$((total_tests + 1))
    
    cat > /tmp/fake_image.jpg << DJVU_EOF
AT&TFORM0000DJVU
DjVu content
qx{id}
DJVU_EOF
    
    response=$(curl -s -w "%{http_code}" -F "image=@/tmp/fake_image.jpg" "$WAF_URL/api/v4/projects/1/uploads" -o /dev/null)
    if [ "$response" = "403" ]; then
        echo -e "${GREEN}âœ“ ä¼ªè£…å›¾ç‰‡æ–‡ä»¶å·²è¢«é˜»æ­¢${NC}"
        test_results+=("âœ“ Test 3: Fake image file blocked")
        passed_tests=$((passed_tests + 1))
    else
        echo -e "${RED}âœ— ä¼ªè£…å›¾ç‰‡æ–‡ä»¶æœªè¢«é˜»æ­¢ (HTTP $response)${NC}"
        test_results+=("âœ— Test 3: Fake image file not blocked")
    fi
    
    # Test 4: Rate limiting
    echo -e "\n${YELLOW}æµ‹è¯• 4: ä¸Šä¼ é¢‘ç‡é™åˆ¶${NC}"
    total_tests=$((total_tests + 1))
    
    local blocked=false
    for i in {1..15}; do
        response=$(curl -s -w "%{http_code}" -F "file=@/tmp/malicious.djvu" "$WAF_URL/uploads/user/" -o /dev/null)
        if [ "$response" = "403" ] && [ $i -gt 10 ]; then
            blocked=true
            break
        fi
        sleep 0.1
    done
    
    if [ "$blocked" = true ]; then
        echo -e "${GREEN}âœ“ ä¸Šä¼ é¢‘ç‡é™åˆ¶ç”Ÿæ•ˆ${NC}"
        test_results+=("âœ“ Test 4: Rate limiting active")
        passed_tests=$((passed_tests + 1))
    else
        echo -e "${RED}âœ— ä¸Šä¼ é¢‘ç‡é™åˆ¶æœªç”Ÿæ•ˆ${NC}"
        test_results+=("âœ— Test 4: Rate limiting not active")
    fi
    
    # Test 5: Large file upload
    echo -e "\n${YELLOW}æµ‹è¯• 5: å¤§æ–‡ä»¶ä¸Šä¼ é™åˆ¶${NC}"
    total_tests=$((total_tests + 1))
    
    dd if=/dev/zero of=/tmp/large_file.djvu bs=1M count=15 2>/dev/null
    response=$(curl -s -w "%{http_code}" -F "file=@/tmp/large_file.djvu" "$WAF_URL/uploads/user/" -o /dev/null)
    if [ "$response" = "403" ]; then
        echo -e "${GREEN}âœ“ å¤§æ–‡ä»¶ä¸Šä¼ å·²è¢«é˜»æ­¢${NC}"
        test_results+=("âœ“ Test 5: Large file upload blocked")
        passed_tests=$((passed_tests + 1))
    else
        echo -e "${RED}âœ— å¤§æ–‡ä»¶ä¸Šä¼ æœªè¢«é˜»æ­¢ (HTTP $response)${NC}"
        test_results+=("âœ— Test 5: Large file upload not blocked")
    fi
    
    # Test 6: Legitimate file upload
    echo -e "\n${YELLOW}æµ‹è¯• 6: åˆæ³•æ–‡ä»¶ä¸Šä¼ ${NC}"
    total_tests=$((total_tests + 1))
    
    echo "This is a legitimate text file" > /tmp/legitimate.txt
    response=$(curl -s -w "%{http_code}" -F "file=@/tmp/legitimate.txt" "$WAF_URL/api/v4/projects/1/uploads" -o /dev/null)
    if [ "$response" != "403" ]; then
        echo -e "${GREEN}âœ“ åˆæ³•æ–‡ä»¶ä¸Šä¼ æ­£å¸¸${NC}"
        test_results+=("âœ“ Test 6: Legitimate file upload allowed")
        passed_tests=$((passed_tests + 1))
    else
        echo -e "${RED}âœ— åˆæ³•æ–‡ä»¶ä¸Šä¼ è¢«è¯¯é˜»æ­¢${NC}"
        test_results+=("âœ— Test 6: Legitimate file upload blocked")
    fi
    
    # Display results
    echo -e "\n${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}           æµ‹è¯•ç»“æœæ±‡æ€»${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    for result in "${test_results[@]}"; do
        echo -e "$result"
    done
    
    echo -e "\n${CYAN}é€šè¿‡æµ‹è¯•: ${GREEN}$passed_tests${CYAN}/$total_tests${NC}"
    
    local pass_rate=$((passed_tests * 100 / total_tests))
    if [ $pass_rate -ge 80 ]; then
        echo -e "${GREEN}âœ“ WAF é˜²æŠ¤æ•ˆæœ: ä¼˜ç§€ ($pass_rate%)${NC}"
    elif [ $pass_rate -ge 60 ]; then
        echo -e "${YELLOW}âš  WAF é˜²æŠ¤æ•ˆæœ: è‰¯å¥½ ($pass_rate%)${NC}"
    else
        echo -e "${RED}âœ— WAF é˜²æŠ¤æ•ˆæœ: éœ€è¦æ”¹è¿› ($pass_rate%)${NC}"
    fi
    
    # Cleanup
    rm -f /tmp/malicious.djvu /tmp/cmd_injection.djvu /tmp/fake_image.jpg /tmp/large_file.djvu /tmp/legitimate.txt
    
    # Generate test report
    generate_test_report "$passed_tests" "$total_tests" "${test_results[@]}"
}

generate_test_report() {
    local passed=$1
    local total=$2
    shift 2
    local results=("$@")
    
    local report_file="test_report_$(date +%Y%m%d_%H%M%S).html"
    
    cat > "$report_file" << HTML_EOF
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVE-2021-22205 WAF æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .pass { color: #27ae60; }
        .fail { color: #e74c3c; }
        .summary { background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .test-item { margin: 10px 0; padding: 10px; border-left: 4px solid #3498db; background: #f8f9fa; }
        .pass-rate { font-size: 24px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ CVE-2021-22205 WAF æµ‹è¯•æŠ¥å‘Š</h1>
            <p>GitLab DjVu RCE é˜²æŠ¤æµ‹è¯•ç»“æœ</p>
            <p>æµ‹è¯•æ—¶é—´: $(date)</p>
        </div>
        
        <div class="summary">
            <div class="pass-rate">é€šè¿‡ç‡: $((passed * 100 / total))%</div>
            <p>é€šè¿‡æµ‹è¯•: $passed/$total</p>
        </div>
        
        <h2>è¯¦ç»†æµ‹è¯•ç»“æœ</h2>
HTML_EOF

    for result in "${results[@]}"; do
        if [[ $result == *"âœ“"* ]]; then
            echo "<div class='test-item pass'>$result</div>" >> "$report_file"
        else
            echo "<div class='test-item fail'>$result</div>" >> "$report_file"
        fi
    done
    
    cat >> "$report_file" << HTML_EOF
        
        <h2>å®‰å…¨å»ºè®®</h2>
        <ul>
            <li>å®šæœŸæ›´æ–° WAF è§„åˆ™ä»¥åº”å¯¹æ–°çš„æ”»å‡»æ¨¡å¼</li>
            <li>ç›‘æ§ WAF æ—¥å¿—ä»¥å‘ç°æ–°çš„æ”»å‡»å°è¯•</li>
            <li>è€ƒè™‘å®æ–½æ›´ä¸¥æ ¼çš„æ–‡ä»¶ä¸Šä¼ é™åˆ¶</li>
            <li>å®šæœŸè¿›è¡Œå®‰å…¨æµ‹è¯•ä»¥éªŒè¯é˜²æŠ¤æ•ˆæœ</li>
        </ul>
        
        <div class="summary">
            <p><strong>æŠ¥å‘Šç”Ÿæˆæ—¶é—´:</strong> $(date)</p>
            <p><strong>æµ‹è¯•ç›®æ ‡:</strong> CVE-2021-22205 (GitLab DjVu RCE)</p>
            <p><strong>WAF ç‰ˆæœ¬:</strong> ModSecurity 2.9.3</p>
        </div>
    </div>
</body>
</html>
HTML_EOF
    
    log_success "æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

# Run tests
test_djvu_protection
EOF

    chmod +x "$test_script"
    log_success "æµ‹è¯•è„šæœ¬å·²ç”Ÿæˆ: $test_script"
}

# Generate cleanup script
generate_cleanup_script() {
    local cleanup_script="$PROJECT_DIR/cleanup.sh"
    
    log_info "ç”Ÿæˆæ¸…ç†è„šæœ¬: $cleanup_script"
    
    cat > "$cleanup_script" << 'EOF'
#!/bin/bash

# CVE-2021-22205 GitLab WAF Protection Cleanup Script

source ../utils/common.sh

cleanup_cve_2021_22205() {
    show_banner "Cleaning up CVE-2021-22205 Protection"
    
    echo -e "${YELLOW}å‡†å¤‡æ¸…ç† GitLab CVE-2021-22205 WAF é˜²æŠ¤ç¯å¢ƒ...${NC}"
    
    if ! confirm_action "ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç›¸å…³å®¹å™¨å’Œæ•°æ®å—ï¼Ÿ"; then
        log_info "æ¸…ç†æ“ä½œå·²å–æ¶ˆ"
        return 0
    fi
    
    # Stop and remove containers
    log_info "åœæ­¢å¹¶åˆ é™¤å®¹å™¨..."
    docker-compose down -v 2>/dev/null || docker compose down -v 2>/dev/null
    
    # Remove containers by name if compose fails
    docker stop gitlab_vulnerable_cve22205 gitlab_waf_cve22205 2>/dev/null
    docker rm gitlab_vulnerable_cve22205 gitlab_waf_cve22205 2>/dev/null
    
    # Remove network
    docker network rm gitlab_cve22205_net 2>/dev/null
    
    # Remove images (optional)
    if confirm_action "æ˜¯å¦åˆ é™¤ç›¸å…³ Docker é•œåƒï¼Ÿ"; then
        docker rmi vulfocus/gitlab-cve_2021_22205:latest 2>/dev/null
        docker rmi owasp/modsecurity:apache 2>/dev/null
        log_info "Docker é•œåƒå·²åˆ é™¤"
    fi
    
    # Clean up volumes
    log_info "æ¸…ç† Docker å·..."
    docker volume prune -f
    
    # Remove temporary files
    log_info "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    rm -f /tmp/malicious.djvu /tmp/cmd_injection.djvu /tmp/fake_image.jpg
    rm -f /tmp/large_file.djvu /tmp/legitimate.txt
    
    log_success "CVE-2021-22205 é˜²æŠ¤ç¯å¢ƒæ¸…ç†å®Œæˆï¼"
    
    echo -e "${CYAN}æ¸…ç†æ‘˜è¦:${NC}"
    echo -e "  âœ“ å®¹å™¨å·²åœæ­¢å¹¶åˆ é™¤"
    echo -e "  âœ“ ç½‘ç»œå·²åˆ é™¤"
    echo -e "  âœ“ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
    echo -e "  âœ“ å·å·²æ¸…ç†"
    
    if confirm_action "æ˜¯å¦åˆ é™¤é¡¹ç›®ç›®å½•ï¼Ÿ"; then
        cd ..
        rm -rf "$(basename "$(pwd)")"
        log_info "é¡¹ç›®ç›®å½•å·²åˆ é™¤"
    else
        log_info "é¡¹ç›®ç›®å½•ä¿ç•™ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨åˆ é™¤"
    fi
}

# Run cleanup
cleanup_cve_2021_22205
EOF

    chmod +x "$cleanup_script"
    log_success "æ¸…ç†è„šæœ¬å·²ç”Ÿæˆ: $cleanup_script"
}

# Monitor WAF status
monitor_waf() {
    show_banner "CVE-2021-22205 WAF çŠ¶æ€ç›‘æ§"
    
    if ! docker ps | grep -q "$WAF_CONTAINER_NAME"; then
        log_error "WAF å®¹å™¨æœªè¿è¡Œï¼Œè¯·å…ˆéƒ¨ç½²é˜²æŠ¤"
        return 1
    fi
    
    echo -e "${CYAN}å®æ—¶ç›‘æ§ WAF çŠ¶æ€... (æŒ‰ Ctrl+C é€€å‡º)${NC}"
    
    while true; do
        clear
        echo -e "${GREEN}=== CVE-2021-22205 WAF ç›‘æ§é¢æ¿ ===${NC}"
        echo -e "æ›´æ–°æ—¶é—´: $(date)"
        echo ""
        
        # Container status
        echo -e "${YELLOW}å®¹å™¨çŠ¶æ€:${NC}"
        docker ps --filter "name=$CONTAINER_NAME" --filter "name=$WAF_CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        echo ""
        
        # WAF logs (last 5 lines)
        echo -e "${YELLOW}æœ€æ–° WAF æ—¥å¿—:${NC}"
        docker logs --tail 5 "$WAF_CONTAINER_NAME" 2>/dev/null | head -5
        echo ""
        
        # Resource usage
        echo -e "${YELLOW}èµ„æºä½¿ç”¨:${NC}"
        docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" "$CONTAINER_NAME" "$WAF_CONTAINER_NAME" 2>/dev/null
        echo ""
        
        echo -e "${CYAN}WAF è®¿é—®åœ°å€: http://localhost:$WAF_PORT${NC}"
        
        sleep 5
    done
}

# View WAF logs
view_logs() {
    show_banner "CVE-2021-22205 WAF æ—¥å¿—æŸ¥çœ‹"
    
    if [ ! -d "$PROJECT_DIR" ]; then
        log_error "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆéƒ¨ç½²é˜²æŠ¤"
        return 1
    fi
    
    echo -e "${CYAN}é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥å¿—:${NC}"
    echo -e "${WHITE}1.${NC} WAF è®¿é—®æ—¥å¿—"
    echo -e "${WHITE}2.${NC} WAF é”™è¯¯æ—¥å¿—"
    echo -e "${WHITE}3.${NC} ModSecurity å®¡è®¡æ—¥å¿—"
    echo -e "${WHITE}4.${NC} ModSecurity è°ƒè¯•æ—¥å¿—"
    echo -e "${WHITE}5.${NC} å®¹å™¨æ—¥å¿—"
    echo -e "${WHITE}0.${NC} è¿”å›"
    
    read -p "è¯·é€‰æ‹©: " choice
    
    case $choice in
        1)
            log_info "æ˜¾ç¤º WAF è®¿é—®æ—¥å¿—..."
            tail -f "$PROJECT_DIR/waf_logs/access.log" 2>/dev/null || log_error "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            ;;
        2)
            log_info "æ˜¾ç¤º WAF é”™è¯¯æ—¥å¿—..."
            tail -f "$PROJECT_DIR/waf_logs/error.log" 2>/dev/null || log_error "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            ;;
        3)
            log_info "æ˜¾ç¤º ModSecurity å®¡è®¡æ—¥å¿—..."
            tail -f "$PROJECT_DIR/waf_logs/modsec_audit.log" 2>/dev/null || log_error "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            ;;
        4)
            log_info "æ˜¾ç¤º ModSecurity è°ƒè¯•æ—¥å¿—..."
            tail -f "$PROJECT_DIR/waf_logs/modsec_debug.log" 2>/dev/null || log_error "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            ;;
        5)
            log_info "æ˜¾ç¤ºå®¹å™¨æ—¥å¿—..."
            echo -e "${YELLOW}GitLab å®¹å™¨æ—¥å¿—:${NC}"
            docker logs --tail 20 "$CONTAINER_NAME" 2>/dev/null
            echo -e "\n${YELLOW}WAF å®¹å™¨æ—¥å¿—:${NC}"
            docker logs --tail 20 "$WAF_CONTAINER_NAME" 2>/dev/null
            ;;
        0)
            return 0
            ;;
        *)
            log_error "æ— æ•ˆé€‰æ‹©"
            ;;
    esac
}

# Main execution
main() {
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-7): " choice
        
        case $choice in
            1)
                generate_deployment_script
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            2)
                cd "$PROJECT_DIR" 2>/dev/null && ./deploy.sh || log_error "è¯·å…ˆç”Ÿæˆéƒ¨ç½²è„šæœ¬"
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            3)
                generate_test_script
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            4)
                monitor_waf
                ;;
            5)
                view_logs
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            6)
                generate_cleanup_script
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            7)
                cd "$PROJECT_DIR" 2>/dev/null && ./cleanup.sh || log_error "è¯·å…ˆç”Ÿæˆæ¸…ç†è„šæœ¬"
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            0)
                log_info "é€€å‡ºç¨‹åº"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥"
                sleep 2
                ;;
        esac
    done
}

# Run main function
main
