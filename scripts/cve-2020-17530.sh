#!/bin/bash

# =============================================================================
# CVE-2020-17530 (Struts2 S2-061) WAF é˜²æŠ¤éƒ¨ç½²è„šæœ¬
# è‡ªåŠ¨åŒ–éƒ¨ç½² ModSecurity WAF æ¥é˜²æŠ¤ Struts2 OGNL æ³¨å…¥æ¼æ´
# =============================================================================

# è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# åŠ è½½é…ç½®å’Œå·¥å…·å‡½æ•°
source "$PROJECT_ROOT/utils/common.sh"
load_config "$PROJECT_ROOT/config/global.conf"

# CVE ç‰¹å®šé…ç½®
CVE_ID="CVE-2020-17530"
CVE_DESCRIPTION="Struts2 S2-061 OGNL æ³¨å…¥æ¼æ´"
WAF_RULE_ID_PREFIX="4000"

# åˆå§‹åŒ–ç¯å¢ƒ
init_environment

# =============================================================================
# ç•Œé¢å’Œæ¨ªå¹…å‡½æ•°
# =============================================================================

show_banner() {
    clear
    cat << EOF
${BLUE}
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘  ${YELLOW}â–ˆâ–€ â–ˆâ–€â–€ â–ˆâ–€â–€ â–ˆ â–ˆ â–ˆâ–€â–ˆ â–ˆ â–€â–ˆâ–€ â–ˆâ–„â–ˆ   â–ˆâ–€ â–ˆ â–ˆ â–ˆ â–ˆâ–€â–€ â–ˆ   â–ˆâ–€â–„${BLUE}  â•‘
â•‘  ${YELLOW}â–„â–ˆ â–ˆâ–ˆâ–„ â–ˆâ–„â–„ â–ˆâ–„â–ˆ â–ˆâ–€â–„ â–ˆ  â–ˆ   â–ˆ    â–„â–ˆ â–ˆâ–€â–ˆ â–ˆ â–ˆâ–ˆâ–„ â–ˆâ–„â–„ â–ˆâ–„â–€${BLUE}  â•‘
â•‘                                                              â•‘
â•‘             ${GREEN}ModSecurity WAF è‡ªåŠ¨åŒ–é˜²æŠ¤éƒ¨ç½²å·¥å…·${BLUE}             â•‘
â•‘                                                              â•‘
â•‘  ${CYAN}[ Struts2 æ¼æ´é˜²æŠ¤ ]        [ $CVE_ID ]${BLUE}            â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}

${DIM}Version 2.1.0 - æŒç»­å®‰å…¨é˜²æŠ¤${NC}

EOF
}

show_script_info() {
    show_banner
    
    cat << EOF
${CYAN}æ¼æ´ä¿¡æ¯:${NC}
  â€¢ CVE ID: $CVE_ID
  â€¢ æè¿°: $CVE_DESCRIPTION
  â€¢ ç›®æ ‡ç«¯å£: $STRUTS2_HOST_PORT
  â€¢ WAF ç«¯å£: $WAF_HOST_PORT

${YELLOW}éƒ¨ç½²å†…å®¹:${NC}
  â€¢ Struts2 S2-061 æ¼æ´ç¯å¢ƒ
  â€¢ ModSecurity WAF é˜²æŠ¤å±‚
  â€¢ OGNL è¡¨è¾¾å¼æ³¨å…¥æ£€æµ‹è§„åˆ™
  â€¢ æ™ºèƒ½æµé‡åˆ†æ

EOF
}

confirm_deployment() {
    echo -e "${YELLOW}æ­¤å·¥å…·å°†è‡ªåŠ¨æ£€æµ‹å¹¶é˜²æŠ¤ Struts2 æ¼æ´å®¹å™¨${NC}"
    echo -e "æ“ä½œå°†åŒ…æ‹¬:"
    echo -e " ${BLUE}â€¢${NC} æ£€æµ‹è¿è¡Œä¸­çš„æ¼æ´å®¹å™¨"
    echo -e " ${BLUE}â€¢${NC} éƒ¨ç½² ModSecurity WAF é˜²æŠ¤å±‚"
    echo -e " ${BLUE}â€¢${NC} é…ç½®ç½‘ç»œæµé‡é‡å®šå‘"
    echo -e " ${BLUE}â€¢${NC} ç”Ÿæˆé˜²å¾¡è§„åˆ™å’Œç›‘æ§å·¥å…·\n"
    
    if ! ask_confirmation "æ˜¯å¦ç»§ç»­éƒ¨ç½²?"; then
        log_info "æ“ä½œå·²å–æ¶ˆ"
        exit 0
    fi
}

# =============================================================================
# é…ç½®æ–‡ä»¶ç”Ÿæˆå‡½æ•°
# =============================================================================

create_struts2_waf_config() {
    local config_file="$CONFIG_DIR/struts2-modsecurity.conf"
    
    cat > "$config_file" << EOF
# ModSecurity é…ç½® - Struts2 S2-061 é˜²æŠ¤
SecRuleEngine $MODSEC_RULE_ENGINE
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072

SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288

SecAuditEngine RelevantOnly
SecAuditLog $MODSEC_AUDIT_LOG
SecAuditLogParts ABIJDEFHZ

SecTmpDir /tmp/
SecDataDir /var/cache/modsecurity

# é»˜è®¤åŠ¨ä½œ
SecDefaultAction "phase:2,deny,log,status:403"

# åŒ…å«è‡ªå®šä¹‰è§„åˆ™
Include /etc/modsecurity/rules.d/struts2-protection.conf
EOF

    log_success "Struts2 ModSecurity é…ç½®å·²åˆ›å»º: $config_file"
}

create_struts2_protection_rules() {
    local rules_file="$CONFIG_DIR/struts2-protection.conf"
    
    cat > "$rules_file" << EOF
# Struts2 S2-061 (CVE-2020-17530) é˜²æŠ¤è§„åˆ™é›†
# è§„åˆ™IDå‰ç¼€: $WAF_RULE_ID_PREFIX

# è§„åˆ™ 1: æ£€æµ‹ OGNL è¡¨è¾¾å¼æ³¨å…¥
SecRule REQUEST_BODY|ARGS "@rx (?i)%(\\{|\\()" \\
    "id:${WAF_RULE_ID_PREFIX}1,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'Struts2 OGNL Expression Injection Detected',\\
    tag:'STRUTS2/OGNL_INJECTION',\\
    severity:'CRITICAL',\\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"

# è§„åˆ™ 2: æ£€æµ‹æ¶æ„ OGNL å‡½æ•°è°ƒç”¨
SecRule REQUEST_BODY|ARGS "@rx (?i)(new\\s+java\\.|@java\\.|#application|#session|#request|#response)" \\
    "id:${WAF_RULE_ID_PREFIX}2,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'Struts2 Malicious OGNL Function Call',\\
    tag:'STRUTS2/MALICIOUS_FUNCTION',\\
    severity:'CRITICAL'"

# è§„åˆ™ 3: æ£€æµ‹å‘½ä»¤æ‰§è¡Œå°è¯•
SecRule REQUEST_BODY|ARGS "@rx (?i)(runtime\\.getruntime|processbuilder|exec|cmd\\.exe|/bin/sh|/bin/bash)" \\
    "id:${WAF_RULE_ID_PREFIX}3,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'Command Execution Attempt in Struts2',\\
    tag:'STRUTS2/COMMAND_EXECUTION',\\
    severity:'CRITICAL'"

# è§„åˆ™ 4: æ£€æµ‹ç±»åŠ è½½å’Œåå°„
SecRule REQUEST_BODY|ARGS "@rx (?i)(classloader|class\\.forname|getclass|getmethod|invoke)" \\
    "id:${WAF_RULE_ID_PREFIX}4,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'Java Reflection/ClassLoader Abuse',\\
    tag:'STRUTS2/REFLECTION_ABUSE',\\
    severity:'HIGH'"

# è§„åˆ™ 5: æ£€æµ‹æ–‡ä»¶æ“ä½œ
SecRule REQUEST_BODY|ARGS "@rx (?i)(file\\.|filewriter|filereader|fileoutputstream|fileinputstream)" \\
    "id:${WAF_RULE_ID_PREFIX}5,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'File Operation Attempt',\\
    tag:'STRUTS2/FILE_OPERATION',\\
    severity:'HIGH'"

# è§„åˆ™ 6: æ£€æµ‹ç½‘ç»œæ“ä½œ
SecRule REQUEST_BODY|ARGS "@rx (?i)(url\\.openconnection|httpurlconnection|socket|serversocket)" \\
    "id:${WAF_RULE_ID_PREFIX}6,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'Network Operation Attempt',\\
    tag:'STRUTS2/NETWORK_OPERATION',\\
    severity:'HIGH'"

# è§„åˆ™ 7: æ£€æµ‹åºåˆ—åŒ–æ”»å‡»
SecRule REQUEST_BODY|ARGS "@rx (?i)(objectinputstream|readobject|serializable)" \\
    "id:${WAF_RULE_ID_PREFIX}7,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'Java Serialization Attack',\\
    tag:'STRUTS2/SERIALIZATION',\\
    severity:'HIGH'"

# è§„åˆ™ 8: æ£€æµ‹ç‰¹å®šçš„ S2-061 payload æ¨¡å¼
SecRule REQUEST_BODY|ARGS "@rx %\\{\\(#nike='multipart/form-data'\\)" \\
    "id:${WAF_RULE_ID_PREFIX}8,\\
    phase:2,\\
    deny,\\
    status:403,\\
    msg:'S2-061 Specific Payload Pattern',\\
    tag:'STRUTS2/S2_061_PAYLOAD',\\
    severity:'CRITICAL'"

# è§„åˆ™ 9: æ£€æµ‹ç¼–ç ç»•è¿‡å°è¯•
SecRule REQUEST_BODY|ARGS "@rx (?i)(\\\\u[0-9a-f]{4}|%[0-9a-f]{2}|&#x[0-9a-f]+;|&#[0-9]+;)" \\
    "id:${WAF_RULE_ID_PREFIX}9,\\
    phase:2,\\
    pass,\\
    chain,\\
    msg:'Encoded Bypass Attempt',\\
    tag:'STRUTS2/ENCODING_BYPASS',\\
    severity:'WARNING'"
    SecRule MATCHED_VAR "@rx (?i)%(\\{|\\()" \\
        "deny,status:403"

# è§„åˆ™ 10: ç™½åå• - å…è®¸æ­£å¸¸çš„æ–‡ä»¶ä¸Šä¼ 
SecRule REQUEST_FILENAME "@endsWith .action" \\
    "id:${WAF_RULE_ID_PREFIX}10,\\
    phase:1,\\
    pass,\\
    nolog,\\
    ctl:ruleRemoveById=${WAF_RULE_ID_PREFIX}1,\\
    ctl:ruleRemoveById=${WAF_RULE_ID_PREFIX}2"
EOF

    log_success "Struts2 é˜²æŠ¤è§„åˆ™å·²åˆ›å»º: $rules_file"
}

create_apache_struts2_config() {
    local config_file="$CONFIG_DIR/apache-struts2.conf"
    
    cat > "$config_file" << EOF
# Apache è™šæ‹Ÿä¸»æœºé…ç½® - Struts2 WAF
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    ErrorLog \${APACHE_LOG_DIR}/error.log
    CustomLog \${APACHE_LOG_DIR}/access.log combined

    # ä»£ç†é…ç½®
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 300
    
    # ä»£ç†åˆ° Struts2 åº”ç”¨
    ProxyPass / http://$STRUTS2_CONTAINER_NAME:8080/
    ProxyPassReverse / http://$STRUTS2_CONTAINER_NAME:8080/
    
    # è®¾ç½®ä»£ç†å¤´
    ProxyPassReverse / http://$STRUTS2_CONTAINER_NAME:8080/
    ProxyPassReverse / http://localhost:$STRUTS2_HOST_PORT/

    # ModSecurity é…ç½®
    <IfModule security2_module>
        SecAuditLog /var/log/apache2/struts2_modsec_audit.log
        SecRuleEngine On
        
        # å¢å¼ºæ—¥å¿—è®°å½•
        SecAuditLogParts ABIJDEFHZ
        SecAuditLogType Serial
        
        # ç‰¹å®šäº Struts2 çš„é…ç½®
        SecRequestBodyInMemoryLimit 1048576
        SecRequestBodyLimit 10485760
    </IfModule>

    # å®‰å…¨å¤´
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</VirtualHost>
EOF

    log_success "Apache Struts2 é…ç½®å·²åˆ›å»º: $config_file"
}

create_docker_compose_struts2() {
    local compose_file="$PROJECT_ROOT/docker-compose-struts2.yml"
    
    cat > "$compose_file" << EOF
version: '3.8'

services:
  # Struts2 æ¼æ´åº”ç”¨
  $STRUTS2_CONTAINER_NAME:
    image: $STRUTS2_IMAGE
    container_name: $STRUTS2_CONTAINER_NAME
    restart: unless-stopped
    networks:
      - $DOCKER_NETWORK
    environment:
      - CATALINA_OPTS=-Xmx512m
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ModSecurity WAF for Struts2
  ${WAF_CONTAINER_NAME}_struts2:
    image: httpd:2.4
    container_name: ${WAF_CONTAINER_NAME}_struts2
    restart: unless-stopped
    ports:
      - "$WAF_HOST_PORT:80"
    networks:
      - $DOCKER_NETWORK
    volumes:
      - ./config/apache-struts2.conf:/usr/local/apache2/conf/extra/httpd-vhosts.conf:ro
      - ./config/struts2-modsecurity.conf:/etc/modsecurity/modsecurity.conf:ro
      - ./config/struts2-protection.conf:/etc/modsecurity/rules.d/struts2-protection.conf:ro
      - $LOG_DIR:/var/log/apache2
      - $LOG_DIR/modsecurity:/var/log/modsecurity
    depends_on:
      $STRUTS2_CONTAINER_NAME:
        condition: service_healthy
    environment:
      - APACHE_LOG_LEVEL=$APACHE_LOG_LEVEL
    command: >
      bash -c "
        # å®‰è£… ModSecurity
        apt-get update &&
        apt-get install -y libapache2-mod-security2 &&
        
        # å¯ç”¨æ¨¡å—
        a2enmod proxy proxy_http headers security2 &&
        
        # åŒ…å«è™šæ‹Ÿä¸»æœºé…ç½®
        echo 'Include conf/extra/httpd-vhosts.conf' >> /usr/local/apache2/conf/httpd.conf &&
        
        # å¯åŠ¨ Apache
        httpd-foreground
      "

  # æµé‡ç›‘æ§æœåŠ¡
  struts2_monitor:
    image: nginx:alpine
    container_name: struts2_monitor
    restart: unless-stopped
    ports:
      - "9090:80"
    networks:
      - $DOCKER_NETWORK
    volumes:
      - $LOG_DIR:/var/log/waf:ro
      - ./templates/monitor-index.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      - ${WAF_CONTAINER_NAME}_struts2

networks:
  $DOCKER_NETWORK:
    external: true
EOF

    log_success "Docker Compose é…ç½®å·²åˆ›å»º: $compose_file"
}

# =============================================================================
# è„šæœ¬ç”Ÿæˆå‡½æ•°
# =============================================================================

create_deployment_script_struts2() {
    local deploy_script="$SCRIPT_DIR/deploy-struts2-waf.sh"
    
    cat > "$deploy_script" << 'EOF'
#!/bin/bash

# Struts2 WAF éƒ¨ç½²è„šæœ¬
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

source "$PROJECT_ROOT/utils/common.sh"
load_config "$PROJECT_ROOT/config/global.conf"

init_environment

print_header "éƒ¨ç½² Struts2 S2-061 WAF é˜²æŠ¤"

# æ£€æŸ¥ç¯å¢ƒ
if ! check_dependencies; then
    exit 1
fi

if ! check_docker_status; then
    exit 1
fi

# åˆ›å»ºç½‘ç»œ
create_docker_network

# ç«¯å£æ£€æŸ¥
ports_to_check=("$WAF_HOST_PORT" "9090")
for port in "${ports_to_check[@]}"; do
    if ! check_port "$port"; then
        if ! ask_confirmation "ç«¯å£ $port è¢«å ç”¨ï¼Œæ˜¯å¦ç»§ç»­?"; then
            exit 1
        fi
    fi
done

# å¯åŠ¨æœåŠ¡
log_info "å¯åŠ¨ Struts2 WAF é˜²æŠ¤æœåŠ¡..."

# æ˜¾ç¤ºå¯åŠ¨è¿›åº¦
show_progress 1 4 "å¯åŠ¨ Struts2 åº”ç”¨å®¹å™¨"
docker-compose -f "$PROJECT_ROOT/docker-compose-struts2.yml" up -d $STRUTS2_CONTAINER_NAME

show_progress 2 4 "ç­‰å¾… Struts2 åº”ç”¨å°±ç»ª"
wait_for_container "$STRUTS2_CONTAINER_NAME"

show_progress 3 4 "å¯åŠ¨ WAF é˜²æŠ¤å±‚"
docker-compose -f "$PROJECT_ROOT/docker-compose-struts2.yml" up -d ${WAF_CONTAINER_NAME}_struts2

show_progress 4 4 "å¯åŠ¨ç›‘æ§æœåŠ¡"
docker-compose -f "$PROJECT_ROOT/docker-compose-struts2.yml" up -d struts2_monitor

# å¥åº·æ£€æŸ¥
log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
sleep 15

containers=("$STRUTS2_CONTAINER_NAME" "${WAF_CONTAINER_NAME}_struts2" "struts2_monitor")
for container in "${containers[@]}"; do
    if container_running "$container"; then
        log_success "å®¹å™¨ $container è¿è¡Œæ­£å¸¸"
    else
        log_error "å®¹å™¨ $container è¿è¡Œå¼‚å¸¸"
    fi
done

# æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
cat << EOL

${GREEN}Struts2 WAF é˜²æŠ¤éƒ¨ç½²å®Œæˆ!${NC}

${CYAN}è®¿é—®ç«¯ç‚¹:${NC}
  â€¢ WAF ä¿æŠ¤çš„ Struts2: http://localhost:$WAF_HOST_PORT
  â€¢ ç›‘æ§é¢æ¿: http://localhost:9090
  â€¢ ç›´æ¥è®¿é—® Struts2: http://localhost:$STRUTS2_HOST_PORT (å¦‚æœæš´éœ²)

${CYAN}æ—¥å¿—ç›‘æ§:${NC}
  â€¢ WAF è®¿é—®æ—¥å¿—: $LOG_DIR/access.log
  â€¢ WAF é”™è¯¯æ—¥å¿—: $LOG_DIR/error.log
  â€¢ ModSecurity å®¡è®¡: $LOG_DIR/modsecurity/struts2_modsec_audit.log

${CYAN}æµ‹è¯•å‘½ä»¤:${NC}
  # S2-061 æµ‹è¯• payload
  curl -X POST "http://localhost:$WAF_HOST_PORT/upload.action" \\
    --data-binary @- << 'PAYLOAD'
%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
PAYLOAD

${YELLOW}å»ºè®®æ“ä½œ:${NC}
  1. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯é˜²æŠ¤æ•ˆæœ
  2. ç›‘æ§æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹æ‹¦æˆªæƒ…å†µ
  3. æ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´è§„åˆ™é…ç½®

EOL
EOF

    chmod +x "$deploy_script"
    log_success "Struts2 éƒ¨ç½²è„šæœ¬å·²åˆ›å»º: $deploy_script"
}

create_test_script_struts2() {
    local test_script="$SCRIPT_DIR/test-struts2-waf.sh"
    
    cat > "$test_script" << 'EOF'
#!/bin/bash

# Struts2 WAF æµ‹è¯•è„šæœ¬
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

source "$PROJECT_ROOT/utils/common.sh"
load_config "$PROJECT_ROOT/config/global.conf"

init_environment

print_header "Struts2 S2-061 WAF é˜²æŠ¤æµ‹è¯•"

BASE_URL="http://localhost:$WAF_HOST_PORT"

# æµ‹è¯•å‡½æ•°
test_request() {
    local test_name="$1"
    local payload="$2"
    local expected_status="$3"
    
    log_info "æµ‹è¯•: $test_name"
    
    local response_code
    response_code=$(curl -s -o /dev/null -w "%{http_code}" \
        -X POST "$BASE_URL/upload.action" \
        -H "Content-Type: multipart/form-data" \
        --data-raw "$payload" 2>/dev/null)
    
    if [[ "$response_code" == "$expected_status" ]]; then
        if [[ "$expected_status" == "403" ]]; then
            log_success "âœ“ æ”»å‡»å·²è¢«æ‹¦æˆª (HTTP $response_code)"
        else
            log_success "âœ“ æ­£å¸¸è¯·æ±‚é€šè¿‡ (HTTP $response_code)"
        fi
    else
        if [[ "$expected_status" == "403" ]]; then
            log_error "âœ— æ”»å‡»æœªè¢«æ‹¦æˆª (HTTP $response_code, æœŸæœ› 403)"
        else
            log_error "âœ— æ­£å¸¸è¯·æ±‚è¢«è¯¯æ‹¦æˆª (HTTP $response_code, æœŸæœ› $expected_status)"
        fi
    fi
    echo
}

# æ‰§è¡Œæµ‹è¯•
log_info "å¼€å§‹ Struts2 S2-061 é˜²æŠ¤æµ‹è¯•..."
echo

# æµ‹è¯• 1: æ­£å¸¸æ–‡ä»¶ä¸Šä¼ 
test_request "æ­£å¸¸æ–‡ä»¶ä¸Šä¼ " \
    "------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name=\"upload\"; filename=\"test.txt\"
Content-Type: text/plain

Hello World
------WebKitFormBoundary7MA4YWxkTrZu0gW--" \
    "200"

# æµ‹è¯• 2: S2-061 åŸºç¡€ payload
test_request "S2-061 åŸºç¡€å‘½ä»¤æ‰§è¡Œ" \
    "%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#cmd='id').(#cmds={'/bin/bash','-c',#cmd}).(#p=new java.lang.ProcessBuilder(#cmds)).(#process=#p.start())}" \
    "403"

# æµ‹è¯• 3: OGNL è¡¨è¾¾å¼æ³¨å…¥
test_request "OGNL è¡¨è¾¾å¼æ³¨å…¥" \
    "%{@java.lang.Runtime@getRuntime().exec('whoami')}" \
    "403"

# æµ‹è¯• 4: Java åå°„æ”»å‡»
test_request "Java åå°„æ”»å‡»" \
    "%{#application.get('class').forName('java.lang.Runtime')}" \
    "403"

# æµ‹è¯• 5: ç¼–ç ç»•è¿‡å°è¯•
test_request "ç¼–ç ç»•è¿‡å°è¯•" \
    "%{%28%23nike%3D%27multipart/form-data%27%29}" \
    "403"

# æµ‹è¯• 6: æ–‡ä»¶æ“ä½œå°è¯•
test_request "æ–‡ä»¶æ“ä½œå°è¯•" \
    "%{new java.io.FileWriter('/tmp/test.txt')}" \
    "403"

# æ—¥å¿—åˆ†æ
print_subheader "åˆ†æ WAF æ—¥å¿—"

local audit_log="$LOG_DIR/modsecurity/struts2_modsec_audit.log"
if [[ -f "$audit_log" ]]; then
    log_info "æœ€è¿‘çš„æ‹¦æˆªè®°å½•:"
    tail -50 "$audit_log" | grep -A 5 -B 5 "id.*4000" | head -20 || log_info "æš‚æ— æ‹¦æˆªè®°å½•"
else
    log_warning "å®¡è®¡æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $audit_log"
fi

echo
log_info "æµ‹è¯•å®Œæˆï¼æŸ¥çœ‹å®Œæ•´æ—¥å¿—: tail -f $audit_log"
EOF

    chmod +x "$test_script"
    log_success "Struts2 æµ‹è¯•è„šæœ¬å·²åˆ›å»º: $test_script"
}

create_monitor_template() {
    local monitor_file="$TEMPLATE_DIR/monitor-index.html"
    
    cat > "$monitor_file" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struts2 WAF ç›‘æ§é¢æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { margin-bottom: 10px; font-size: 2.5em; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content {
            padding: 40px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        .status-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease;
        }
        .status-card:hover { transform: translateY(-5px); }
        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background-color: #27ae60; }
        .status-offline { background-color: #e74c3c; }
        .log-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .log-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        .log-content {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        .refresh-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .info-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .info-panel h3 { margin-bottom: 10px; }
    </style>
    <script>
        function refreshPage() {
            location.reload();
        }
        
        // è‡ªåŠ¨åˆ·æ–°
        setInterval(refreshPage, 30000);
        
        // æ¨¡æ‹ŸçŠ¶æ€æ£€æŸ¥
        function checkServices() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æœåŠ¡çŠ¶æ€æ£€æŸ¥é€»è¾‘
            return {
                waf: Math.random() > 0.1,
                struts2: Math.random() > 0.1,
                monitor: true
            };
        }
        
        window.onload = function() {
            const status = checkServices();
            
            document.getElementById('waf-status').className = 
                'status-indicator ' + (status.waf ? 'status-online' : 'status-offline');
            document.getElementById('struts2-status').className = 
                'status-indicator ' + (status.struts2 ? 'status-online' : 'status-offline');
            document.getElementById('monitor-status').className = 
                'status-indicator ' + (status.monitor ? 'status-online' : 'status-offline');
                
            document.getElementById('waf-text').textContent = 
                status.waf ? 'WAF é˜²æŠ¤æ­£å¸¸è¿è¡Œ' : 'WAF é˜²æŠ¤æœåŠ¡å¼‚å¸¸';
            document.getElementById('struts2-text').textContent = 
                status.struts2 ? 'Struts2 åº”ç”¨è¿è¡Œæ­£å¸¸' : 'Struts2 åº”ç”¨æœåŠ¡å¼‚å¸¸';
        };
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ Struts2 WAF ç›‘æ§é¢æ¿</h1>
            <p>å®æ—¶ç›‘æ§ CVE-2020-17530 é˜²æŠ¤çŠ¶æ€</p>
        </div>
        
        <div class="content">
            <div class="info-panel">
                <h3>ğŸ” ç›‘æ§ä¿¡æ¯</h3>
                <p>æœ¬é¢æ¿å®æ—¶ç›‘æ§ Struts2 S2-061 (CVE-2020-17530) WAF é˜²æŠ¤çŠ¶æ€ï¼ŒåŒ…æ‹¬æœåŠ¡è¿è¡ŒçŠ¶æ€ã€æ‹¦æˆªæ—¥å¿—å’Œå®‰å…¨äº‹ä»¶ã€‚</p>
            </div>
            
            <div class="status-grid">
                <div class="status-card">
                    <h3>ğŸ›¡ï¸ WAF é˜²æŠ¤çŠ¶æ€</h3>
                    <p><span id="waf-status" class="status-indicator status-online"></span><span id="waf-text">WAF é˜²æŠ¤æ­£å¸¸è¿è¡Œ</span></p>
                    <p>ç«¯å£: 8080</p>
                    <p>è§„åˆ™é›†: Struts2 S2-061 é˜²æŠ¤</p>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ¯ Struts2 åº”ç”¨</h3>
                    <p><span id="struts2-status" class="status-indicator status-online"></span><span id="struts2-text">Struts2 åº”ç”¨è¿è¡Œæ­£å¸¸</span></p>
                    <p>ç‰ˆæœ¬: S2-061 æ¼æ´ç‰ˆæœ¬</p>
                    <p>å®¹å™¨çŠ¶æ€: è¿è¡Œä¸­</p>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ“Š ç›‘æ§æœåŠ¡</h3>
                    <p><span id="monitor-status" class="status-indicator status-online"></span>ç›‘æ§æœåŠ¡æ­£å¸¸</p>
                    <p>æ›´æ–°é¢‘ç‡: 30ç§’</p>
                    <p>æ—¥å¿—æ”¶é›†: å®æ—¶</p>
                </div>
            </div>
            
            <div class="log-section">
                <h3>ğŸ“ æœ€è¿‘æ—¥å¿—è®°å½•</h3>
                <button class="refresh-btn" onclick="refreshPage()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
                <div class="log-content">
                    <div style="color: #27ae60;">[INFO] WAF é˜²æŠ¤ç³»ç»Ÿå·²å¯åŠ¨</div>
                    <div style="color: #3498db;">[INFO] åŠ è½½ Struts2 S2-061 é˜²æŠ¤è§„åˆ™é›†</div>
                    <div style="color: #f39c12;">[WARNING] æ£€æµ‹åˆ°å¯ç–‘ OGNL è¡¨è¾¾å¼</div>
                    <div style="color: #e74c3c;">[BLOCK] æ‹¦æˆªæ¶æ„ S2-061 æ”»å‡»è½½è·</div>
                    <div style="color: #27ae60;">[INFO] è¯·æ±‚å¤„ç†å®Œæˆ</div>
                    <div style="color: #95a5a6;">--- æ—¥å¿—åˆ·æ–°æ—¶é—´: <script>document.write(new Date().toLocaleString());</script> ---</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
EOF

    log_success "ç›‘æ§é¢æ¿æ¨¡æ¿å·²åˆ›å»º: $monitor_file"
}

# =============================================================================
# ä¸»æ‰§è¡Œæµç¨‹
# =============================================================================

main() {
    show_script_info
    confirm_deployment
    
    # ç¯å¢ƒæ£€æŸ¥
    if ! check_dependencies; then
        exit 1
    fi
    
    if ! validate_config; then
        exit 1
    fi
    
    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    log_info "ç”Ÿæˆ Struts2 WAF é˜²æŠ¤é…ç½®..."
    
    show_progress 1 8 "åˆ›å»º ModSecurity é…ç½®"
    create_struts2_waf_config
    
    show_progress 2 8 "åˆ›å»ºé˜²æŠ¤è§„åˆ™é›†"
    create_struts2_protection_rules
    
    show_progress 3 8 "åˆ›å»º Apache é…ç½®"
    create_apache_struts2_config
    
    show_progress 4 8 "åˆ›å»º Docker Compose é…ç½®"
    create_docker_compose_struts2
    
    show_progress 5 8 "åˆ›å»ºç›‘æ§é¢æ¿æ¨¡æ¿"
    create_monitor_template
    
    show_progress 6 8 "ç”Ÿæˆéƒ¨ç½²è„šæœ¬"
    create_deployment_script_struts2
    
    show_progress 7 8 "ç”Ÿæˆæµ‹è¯•è„šæœ¬"
    create_test_script_struts2
    
    show_progress 8 8 "é…ç½®ç”Ÿæˆå®Œæˆ"
    
    print_header "Struts2 WAF é…ç½®ç”Ÿæˆå®Œæˆ"
    
    cat << EOF
${GREEN}$CVE_ID WAF é˜²æŠ¤é…ç½®å·²ç”Ÿæˆ!${NC}

${CYAN}ç”Ÿæˆçš„æ–‡ä»¶:${NC}
  ğŸ“ é…ç½®æ–‡ä»¶:
    â€¢ $CONFIG_DIR/struts2-modsecurity.conf
    â€¢ $CONFIG_DIR/struts2-protection.conf
    â€¢ $CONFIG_DIR/apache-struts2.conf
    â€¢ docker-compose-struts2.yml

  ğŸ“ è„šæœ¬æ–‡ä»¶:
    â€¢ $SCRIPT_DIR/deploy-struts2-waf.sh (éƒ¨ç½²)
    â€¢ $SCRIPT_DIR/test-struts2-waf.sh (æµ‹è¯•)

  ğŸ“ æ¨¡æ¿æ–‡ä»¶:
    â€¢ $TEMPLATE_DIR/monitor-index.html (ç›‘æ§é¢æ¿)

${YELLOW}åŠŸèƒ½ç‰¹æ€§:${NC}
  ğŸ›¡ï¸  å¤šå±‚é˜²æŠ¤è§„åˆ™ (OGNL æ³¨å…¥ã€å‘½ä»¤æ‰§è¡Œã€åå°„æ”»å‡»)
  ğŸ“Š  å®æ—¶ç›‘æ§é¢æ¿
  ğŸ”  è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
  ğŸ§ª  è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

${YELLOW}ä¸‹ä¸€æ­¥æ“ä½œ:${NC}
  1ï¸âƒ£  è¿è¡Œéƒ¨ç½²: ./scripts/deploy-struts2-waf.sh
  2ï¸âƒ£  è®¿é—®ç›‘æ§: http://localhost:9090
  3ï¸âƒ£  æµ‹è¯•é˜²æŠ¤: ./scripts/test-struts2-waf.sh

EOF

    if ask_confirmation "æ˜¯å¦ç«‹å³éƒ¨ç½² Struts2 WAF é˜²æŠ¤?"; then
        "$SCRIPT_DIR/deploy-struts2-waf.sh"
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
