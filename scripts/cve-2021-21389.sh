#!/bin/bash

# =============================================================================
# CVE-2021-21389 (WordPress BuddyPress) WAF é˜²æŠ¤éƒ¨ç½²è„šæœ¬
# è‡ªåŠ¨åŒ–éƒ¨ç½² ModSecurity WAF æ¥é˜²æŠ¤ BuddyPress æƒé™æå‡æ¼æ´
# =============================================================================

# è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# åŠ è½½é…ç½®å’Œå·¥å…·å‡½æ•°
source "$PROJECT_ROOT/utils/common.sh"
load_config "$PROJECT_ROOT/config/global.conf"

# CVE ç‰¹å®šé…ç½®
CVE_ID="CVE-2021-21389"
CVE_DESCRIPTION="WordPress BuddyPress æƒé™æå‡æ¼æ´"
WAF_RULE_ID_PREFIX="5000"

# åˆå§‹åŒ–ç¯å¢ƒ
init_environment

# =============================================================================
# ä¸»è¦åŠŸèƒ½å‡½æ•°
# =============================================================================

show_script_info() {
    print_header "CVE-2021-21389 BuddyPress WAF é˜²æŠ¤éƒ¨ç½²"
    
    cat << EOF
${CYAN}æ¼æ´ä¿¡æ¯:${NC}
  â€¢ CVE ID: $CVE_ID
  â€¢ æè¿°: $CVE_DESCRIPTION
  â€¢ å½±å“ç»„ä»¶: WordPress BuddyPress Plugin
  â€¢ ç›®æ ‡ç«¯å£: $WORDPRESS_HOST_PORT
  â€¢ WAF ç«¯å£: $WAF_HOST_PORT

${YELLOW}é˜²æŠ¤å†…å®¹:${NC}
  â€¢ WordPress + BuddyPress æ¼æ´ç¯å¢ƒ
  â€¢ ModSecurity WAF é˜²æŠ¤å±‚
  â€¢ REST API æƒé™æ£€æŸ¥è§„åˆ™
  â€¢ JSON è½½è·æ·±åº¦æ£€æµ‹

${RED}æ¼æ´å±é™©æ€§:${NC}
  â€¢ æƒé™æå‡æ”»å‡»
  â€¢ æœªæˆæƒç®¡ç†å‘˜è®¿é—®
  â€¢ ç”¨æˆ·è§’è‰²ç¯¡æ”¹

EOF
}

# åˆ›å»º BuddyPress é˜²æŠ¤è§„åˆ™
create_buddypress_protection_rules() {
    local rules_file="$CONFIG_DIR/buddypress-protection.conf"
    
    cat > "$rules_file" << EOF
# BuddyPress CVE-2021-21389 æƒé™æå‡é˜²æŠ¤è§„åˆ™é›†
# è§„åˆ™IDå‰ç¼€: $WAF_RULE_ID_PREFIX

# å¯ç”¨ JSON è¯·æ±‚ä½“å¤„ç†å™¨
SecRule REQUEST_HEADERS:Content-Type "@rx ^application/(?:[a-zA-Z0-9.-]+\\+)?json" \\
    "id:${WAF_RULE_ID_PREFIX}0,\\
    phase:1,\\
    t:none,t:lowercase,\\
    pass,\\
    nolog,\\
    ctl:requestBodyProcessor=JSON"

# è§„åˆ™ 1: æ£€æµ‹å¯¹ BuddyPress members API çš„å¯ç–‘è®¿é—®
SecRule REQUEST_URI "@streq /wp-json/buddypress/v1/members/me" \\
    "id:${WAF_RULE_ID_PREFIX}1,\\
    phase:2,\\
    t:none,t:lowercase,t:urlDecode,t:normalizePathWin,\\
    pass,\\
    chain,\\
    msg:'BuddyPress Members API Access Detected',\\
    tag:'BUDDYPRESS/API_ACCESS',\\
    severity:'INFO',\\
    setvar:'tx.buddypress_score=+1'"
    SecRule REQUEST_METHOD "@streq POST" \\
        "t:none"

# è§„åˆ™ 2: æ ¸å¿ƒé˜²æŠ¤ - æ£€æµ‹ roles å‚æ•°ä¸­çš„ administrator å€¼
SecRule REQUEST_URI "@streq /wp-json/buddypress/v1/members/me" \\
    "id:${WAF_RULE_ID_PREFIX}2,\\
    phase:2,\\
    t:none,t:lowercase,t:urlDecode,t:normalizePathWin,\\
    deny,\\
    status:403,\\
    chain,\\
    msg:'CVE-2021-21389: Attempt to set roles to administrator via BuddyPress API',\\
    tag:'BUDDYPRESS/PRIVILEGE_ESCALATION',\\
    severity:'CRITICAL',\\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
    SecRule REQUEST_METHOD "@streq POST" \\
        "t:none" \\
        "chain"
    SecRule ARGS:roles "@rx ^administrator\$" \\
        "t:none,t:lowercase,t:removeNulls,t:compressWhitespace"

# è§„åˆ™ 3: æ£€æµ‹å…¶ä»–é«˜æƒé™è§’è‰²æå‡å°è¯•
SecRule REQUEST_URI "@streq /wp-json/buddypress/v1/members/me" \\
    "id:${WAF_RULE_ID_PREFIX}3,\\
    phase:2,\\
    deny,\\
    status:403,\\
    chain,\\
    msg:'BuddyPress High Privilege Role Assignment Attempt',\\
    tag:'BUDDYPRESS/HIGH_PRIVILEGE_ROLE',\\
    severity:'HIGH'"
    SecRule REQUEST_METHOD "@streq POST" \\
        "t:none" \\
        "chain"
    SecRule ARGS:roles "@rx (?i)^(admin|administrator|super_admin|editor)\$" \\
        "t:none,t:removeNulls,t:compressWhitespace"

# è§„åˆ™ 4: æ£€æµ‹æ‰¹é‡ç”¨æˆ·ä¿®æ”¹å°è¯•
SecRule REQUEST_URI "@rx ^/wp-json/buddypress/v1/members/[0-9]+\$" \\
    "id:${WAF_RULE_ID_PREFIX}4,\\
    phase:2,\\
    pass,\\
    chain,\\
    msg:'BuddyPress Member Modification Attempt',\\
    tag:'BUDDYPRESS/MEMBER_MODIFICATION',\\
    severity:'WARNING',\\
    setvar:'tx.buddypress_score=+3'"
    SecRule REQUEST_METHOD "@streq POST" \\
        "t:none" \\
        "chain"
    SecRule ARGS:roles "@rx (?i)(admin|administrator|editor)" \\
        "deny,status:403"

# è§„åˆ™ 5: æ£€æµ‹ JSON è½½è·ä¸­çš„è§’è‰²æå‡
SecRule REQUEST_HEADERS:Content-Type "@rx application/json" \\
    "id:${WAF_RULE_ID_PREFIX}5,\\
    phase:2,\\
    pass,\\
    chain,\\
    msg:'JSON Role Escalation in Request Body',\\
    tag:'BUDDYPRESS/JSON_ROLE_ESCALATION',\\
    severity:'HIGH'"
    SecRule REQUEST_BODY "@rx \\\"roles\\\"\\s*:\\s*\\\"administrator\\\"" \\
        "deny,status:403"

# è§„åˆ™ 6: æ£€æµ‹ç¼–ç ç»•è¿‡å°è¯•
SecRule REQUEST_URI "@streq /wp-json/buddypress/v1/members/me" \\
    "id:${WAF_RULE_ID_PREFIX}6,\\
    phase:2,\\
    deny,\\
    status:403,\\
    chain,\\
    msg:'BuddyPress Encoding Bypass Attempt',\\
    tag:'BUDDYPRESS/ENCODING_BYPASS',\\
    severity:'HIGH'"
    SecRule ARGS:roles "@rx (?i)(%61%64%6d%69%6e|\\\\u0061\\\\u0064\\\\u006d\\\\u0069\\\\u006e)" \\
        "t:urlDecode,t:jsDecode"

# è§„åˆ™ 7: æ£€æµ‹ç”¨æˆ·èƒ½åŠ› (capabilities) ä¿®æ”¹
SecRule REQUEST_URI "@rx ^/wp-json/buddypress/v1/members/" \\
    "id:${WAF_RULE_ID_PREFIX}7,\\
    phase:2,\\
    deny,\\
    status:403,\\
    chain,\\
    msg:'BuddyPress User Capabilities Modification',\\
    tag:'BUDDYPRESS/CAPABILITY_MODIFICATION',\\
    severity:'HIGH'"
    SecRule ARGS "@rx (?i)(capabilities|user_level|allcaps)" \\
        "t:none"

# è§„åˆ™ 8: é€Ÿç‡é™åˆ¶ - é˜²æ­¢æš´åŠ›æ”»å‡»
SecRule REQUEST_URI "@rx ^/wp-json/buddypress/v1/members/" \\
    "id:${WAF_RULE_ID_PREFIX}8,\\
    phase:2,\\
    pass,\\
    nolog,\\
    setvar:'ip.buddypress_requests=+1',\\
    expirevar:'ip.buddypress_requests=60'"

SecRule IP:buddypress_requests "@gt 10" \\
    "id:${WAF_RULE_ID_PREFIX}9,\\
    phase:2,\\
    deny,\\
    status:429,\\
    msg:'Rate Limit Exceeded for BuddyPress API',\\
    tag:'BUDDYPRESS/RATE_LIMIT',\\
    severity:'WARNING'"

# è§„åˆ™ 10: ç™½åå• - å…è®¸æ­£å¸¸çš„ç”¨æˆ·èµ„æ–™æ›´æ–°
SecRule REQUEST_URI "@streq /wp-json/buddypress/v1/members/me" \\
    "id:${WAF_RULE_ID_PREFIX}10,\\
    phase:2,\\
    pass,\\
    chain,\\
    msg:'Normal Profile Update Allowed',\\
    tag:'BUDDYPRESS/NORMAL_UPDATE',\\
    severity:'INFO'"
    SecRule REQUEST_METHOD "@streq POST" \\
        "t:none" \\
        "chain"
    SecRule ARGS:roles "@rx ^(subscriber|contributor|author)\$" \\
        "t:none,t:lowercase"
EOF

    log_success "BuddyPress é˜²æŠ¤è§„åˆ™å·²åˆ›å»º: $rules_file"
}

# åˆ›å»º WordPress WAF é…ç½®
create_wordpress_waf_config() {
    local config_file="$CONFIG_DIR/wordpress-modsecurity.conf"
    
    cat > "$config_file" << EOF
# ModSecurity é…ç½® - WordPress BuddyPress é˜²æŠ¤
SecRuleEngine $MODSEC_RULE_ENGINE

# è¯·æ±‚ä½“å¤„ç†
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072

# JSON å¤„ç†é…ç½®
SecRequestBodyLimitAction Reject
SecRequestBodyJsonDepthLimit 512
SecRequestBodyNoFilesLimit 131072

# å“åº”ä½“å¤„ç†
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json application/javascript
SecResponseBodyLimit 524288

# å®¡è®¡é…ç½®
SecAuditEngine RelevantOnly
SecAuditLog $MODSEC_AUDIT_LOG
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial

# ä¸´æ—¶ç›®å½•é…ç½®
SecTmpDir /tmp/
SecDataDir /var/cache/modsecurity

# é»˜è®¤åŠ¨ä½œ
SecDefaultAction "phase:2,deny,log,status:403"

# åŒ…å« BuddyPress é˜²æŠ¤è§„åˆ™
Include /etc/modsecurity/rules.d/buddypress-protection.conf

# WordPress åŸºç¡€é˜²æŠ¤
SecRule REQUEST_URI "@beginsWith /wp-admin/" \\
    "id:6001,\\
    phase:1,\\
    pass,\\
    nolog,\\
    setvar:'tx.wordpress_admin=1'"

SecRule REQUEST_URI "@beginsWith /wp-json/" \\
    "id:6002,\\
    phase:1,\\
    pass,\\
    nolog,\\
    setvar:'tx.wordpress_api=1'"
EOF

    log_success "WordPress ModSecurity é…ç½®å·²åˆ›å»º: $config_file"
}

# åˆ›å»º Apache WordPress é…ç½®
create_apache_wordpress_config() {
    local config_file="$CONFIG_DIR/apache-wordpress.conf"
    
    cat > "$config_file" << EOF
# Apache è™šæ‹Ÿä¸»æœºé…ç½® - WordPress BuddyPress WAF
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    ErrorLog \${APACHE_LOG_DIR}/error.log
    CustomLog \${APACHE_LOG_DIR}/access.log combined

    # ä»£ç†é…ç½®
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 300
    
    # ä»£ç†åˆ° WordPress åº”ç”¨
    ProxyPass / http://$WORDPRESS_CONTAINER_NAME:80/
    ProxyPassReverse / http://$WORDPRESS_CONTAINER_NAME:80/
    
    # è®¾ç½®ä»£ç†å¤´
    ProxyPassReverse / http://localhost:$WORDPRESS_HOST_PORT/

    # ModSecurity é…ç½®
    <IfModule security2_module>
        SecAuditLog /var/log/apache2/wordpress_modsec_audit.log
        SecRuleEngine On
        
        # å¢å¼º JSON å¤„ç†
        SecRequestBodyJsonDepthLimit 512
        SecRequestBodyInMemoryLimit 2097152
        
        # WordPress ç‰¹å®šé…ç½®
        SecRule REQUEST_URI "@beginsWith /wp-json/" \\
            "id:7001,\\
            phase:1,\\
            pass,\\
            nolog,\\
            ctl:requestBodyProcessor=JSON"
    </IfModule>

    # WordPress å®‰å…¨å¤´
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # BuddyPress API ç‰¹æ®Šå¤„ç†
    <LocationMatch "^/wp-json/buddypress/">
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </LocationMatch>
</VirtualHost>
EOF

    log_success "Apache WordPress é…ç½®å·²åˆ›å»º: $config_file"
}

# åˆ›å»º Docker Compose é…ç½®
create_docker_compose_wordpress() {
    local compose_file="$PROJECT_ROOT/docker-compose-wordpress.yml"
    
    cat > "$compose_file" << EOF
version: '3.8'

services:
  # WordPress BuddyPress æ¼æ´åº”ç”¨
  $WORDPRESS_CONTAINER_NAME:
    image: $WORDPRESS_IMAGE
    container_name: $WORDPRESS_CONTAINER_NAME
    restart: unless-stopped
    networks:
      - $DOCKER_NETWORK
    environment:
      - WORDPRESS_DB_HOST=mysql
      - WORDPRESS_DB_USER=wordpress
      - WORDPRESS_DB_PASSWORD=wordpress
      - WORDPRESS_DB_NAME=wordpress
    expose:
      - "80"
    depends_on:
      - mysql
    volumes:
      - wordpress_data:/var/www/html
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/wp-json/"]
      interval: 30s
      timeout: 10s
      retries: 5

  # MySQL æ•°æ®åº“
  mysql:
    image: mysql:5.7
    container_name: wordpress_mysql
    restart: unless-stopped
    networks:
      - $DOCKER_NETWORK
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - MYSQL_PASSWORD=wordpress
    volumes:
      - mysql_data:/var/lib/mysql

  # ModSecurity WAF for WordPress
  ${WAF_CONTAINER_NAME}_wordpress:
    image: httpd:2.4-alpine
    container_name: ${WAF_CONTAINER_NAME}_wordpress
    restart: unless-stopped
    ports:
      - "$WAF_HOST_PORT:80"
    networks:
      - $DOCKER_NETWORK
    volumes:
      - ./config/apache-wordpress.conf:/usr/local/apache2/conf/extra/httpd-vhosts.conf:ro
      - ./config/wordpress-modsecurity.conf:/etc/modsecurity/modsecurity.conf:ro
      - ./config/buddypress-protection.conf:/etc/modsecurity/rules.d/buddypress-protection.conf:ro
      - $LOG_DIR:/var/log/apache2
      - $LOG_DIR/modsecurity:/var/log/modsecurity
    depends_on:
      $WORDPRESS_CONTAINER_NAME:
        condition: service_healthy
    environment:
      - APACHE_LOG_LEVEL=$APACHE_LOG_LEVEL
    command: >
      sh -c "
        # å®‰è£…å¿…è¦çš„åŒ…
        apk add --no-cache curl &&
        
        # ä¸‹è½½å¹¶å®‰è£… ModSecurity
        apk add --no-cache --virtual .build-deps gcc musl-dev make &&
        apk add --no-cache libxml2-dev curl-dev apache2-mod-security &&
        
        # é…ç½® Apache
        echo 'LoadModule security2_module modules/mod_security2.so' >> /usr/local/apache2/conf/httpd.conf &&
        echo 'LoadModule proxy_module modules/mod_proxy.so' >> /usr/local/apache2/conf/httpd.conf &&
        echo 'LoadModule proxy_http_module modules/mod_proxy_http.so' >> /usr/local/apache2/conf/httpd.conf &&
        echo 'LoadModule headers_module modules/mod_headers.so' >> /usr/local/apache2/conf/httpd.conf &&
        echo 'Include conf/extra/httpd-vhosts.conf' >> /usr/local/apache2/conf/httpd.conf &&
        
        # å¯åŠ¨ Apache
        httpd-foreground
      "

  # WordPress ç®¡ç†é¢æ¿ç›‘æ§
  wordpress_monitor:
    image: nginx:alpine
    container_name: wordpress_monitor
    restart: unless-stopped
    ports:
      - "9091:80"
    networks:
      - $DOCKER_NETWORK
    volumes:
      - $LOG_DIR:/var/log/waf:ro
      - ./templates/wordpress-monitor.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      - ${WAF_CONTAINER_NAME}_wordpress

volumes:
  wordpress_data:
  mysql_data:

networks:
  $DOCKER_NETWORK:
    external: true
EOF

    log_success "Docker Compose WordPress é…ç½®å·²åˆ›å»º: $compose_file"
}

# =============================================================================
# è„šæœ¬ç”Ÿæˆå‡½æ•°
# =============================================================================

create_deployment_script_wordpress() {
    local deploy_script="$SCRIPT_DIR/deploy-wordpress-waf.sh"
    
    cat > "$deploy_script" << 'EOF'
#!/bin/bash

# WordPress BuddyPress WAF éƒ¨ç½²è„šæœ¬
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

source "$PROJECT_ROOT/utils/common.sh"
load_config "$PROJECT_ROOT/config/global.conf"

init_environment

print_header "éƒ¨ç½² WordPress BuddyPress CVE-2021-21389 WAF é˜²æŠ¤"

# æ£€æŸ¥ç¯å¢ƒ
if ! check_dependencies; then
    exit 1
fi

if ! check_docker_status; then
    exit 1
fi

# åˆ›å»ºç½‘ç»œ
create_docker_network

# ç«¯å£æ£€æŸ¥
ports_to_check=("$WAF_HOST_PORT" "9091")
for port in "${ports_to_check[@]}"; do
    if ! check_port "$port"; then
        if ! ask_confirmation "ç«¯å£ $port è¢«å ç”¨ï¼Œæ˜¯å¦ç»§ç»­?"; then
            exit 1
        fi
    fi
done

# å¯åŠ¨æœåŠ¡
log_info "å¯åŠ¨ WordPress BuddyPress WAF é˜²æŠ¤æœåŠ¡..."

# æ˜¾ç¤ºå¯åŠ¨è¿›åº¦
show_progress 1 5 "å¯åŠ¨ MySQL æ•°æ®åº“"
docker-compose -f "$PROJECT_ROOT/docker-compose-wordpress.yml" up -d mysql

show_progress 2 5 "ç­‰å¾…æ•°æ®åº“å°±ç»ª"
sleep 20

show_progress 3 5 "å¯åŠ¨ WordPress åº”ç”¨"
docker-compose -f "$PROJECT_ROOT/docker-compose-wordpress.yml" up -d $WORDPRESS_CONTAINER_NAME

show_progress 4 5 "å¯åŠ¨ WAF é˜²æŠ¤å±‚"
wait_for_container "$WORDPRESS_CONTAINER_NAME"
docker-compose -f "$PROJECT_ROOT/docker-compose-wordpress.yml" up -d ${WAF_CONTAINER_NAME}_wordpress

show_progress 5 5 "å¯åŠ¨ç›‘æ§æœåŠ¡"
docker-compose -f "$PROJECT_ROOT/docker-compose-wordpress.yml" up -d wordpress_monitor

# å¥åº·æ£€æŸ¥
log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
sleep 30

containers=("mysql" "$WORDPRESS_CONTAINER_NAME" "${WAF_CONTAINER_NAME}_wordpress" "wordpress_monitor")
for container in "${containers[@]}"; do
    if container_running "$container"; then
        log_success "å®¹å™¨ $container è¿è¡Œæ­£å¸¸"
    else
        log_error "å®¹å™¨ $container è¿è¡Œå¼‚å¸¸"
    fi
done

# æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
cat << EOL

${GREEN}WordPress BuddyPress WAF é˜²æŠ¤éƒ¨ç½²å®Œæˆ!${NC}

${CYAN}è®¿é—®ç«¯ç‚¹:${NC}
  â€¢ WAF ä¿æŠ¤çš„ WordPress: http://localhost:$WAF_HOST_PORT
  â€¢ ç›‘æ§é¢æ¿: http://localhost:9091
  â€¢ WordPress ç®¡ç†åå°: http://localhost:$WAF_HOST_PORT/wp-admin/

${CYAN}é»˜è®¤ç™»å½•ä¿¡æ¯:${NC}
  â€¢ ç”¨æˆ·å: admin
  â€¢ å¯†ç : admin (é¦–æ¬¡è®¿é—®æ—¶è®¾ç½®)

${CYAN}BuddyPress API ç«¯ç‚¹:${NC}
  â€¢ ç”¨æˆ·ä¿¡æ¯: http://localhost:$WAF_HOST_PORT/wp-json/buddypress/v1/members/me
  â€¢ ç”¨æˆ·åˆ—è¡¨: http://localhost:$WAF_HOST_PORT/wp-json/buddypress/v1/members/

${CYAN}æ—¥å¿—ç›‘æ§:${NC}
  â€¢ WAF è®¿é—®æ—¥å¿—: $LOG_DIR/access.log
  â€¢ WAF é”™è¯¯æ—¥å¿—: $LOG_DIR/error.log
  â€¢ ModSecurity å®¡è®¡: $LOG_DIR/modsecurity/wordpress_modsec_audit.log

${CYAN}æµ‹è¯•å‘½ä»¤:${NC}
  # CVE-2021-21389 æµ‹è¯• payload
  curl -X POST "http://localhost:$WAF_HOST_PORT/wp-json/buddypress/v1/members/me" \\
    -H "Content-Type: application/json" \\
    -d '{"roles": "administrator"}'

${YELLOW}é‡è¦æé†’:${NC}
  1. é¦–æ¬¡è®¿é—® WordPress éœ€è¦å®Œæˆå®‰è£…å‘å¯¼
  2. å®‰è£…å¹¶æ¿€æ´» BuddyPress æ’ä»¶ä»¥æµ‹è¯•æ¼æ´
  3. åˆ›å»ºæµ‹è¯•ç”¨æˆ·è¿›è¡Œæƒé™æå‡æµ‹è¯•

EOL
EOF

    chmod +x "$deploy_script"
    log_success "WordPress éƒ¨ç½²è„šæœ¬å·²åˆ›å»º: $deploy_script"
}

create_test_script_wordpress() {
    local test_script="$SCRIPT_DIR/test-wordpress-waf.sh"
    
    cat > "$test_script" << 'EOF'
#!/bin/bash

# WordPress BuddyPress WAF æµ‹è¯•è„šæœ¬
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

source "$PROJECT_ROOT/utils/common.sh"
load_config "$PROJECT_ROOT/config/global.conf"

init_environment

print_header "WordPress BuddyPress CVE-2021-21389 WAF é˜²æŠ¤æµ‹è¯•"

BASE_URL="http://localhost:$WAF_HOST_PORT"
API_ENDPOINT="$BASE_URL/wp-json/buddypress/v1/members/me"

# æµ‹è¯•å‡½æ•°
test_api_request() {
    local test_name="$1"
    local payload="$2"
    local expected_status="$3"
    local headers="$4"
    
    log_info "æµ‹è¯•: $test_name"
    
    local response_code
    if [[ -n "$headers" ]]; then
        response_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "$API_ENDPOINT" \
            -H "$headers" \
            --data-raw "$payload" 2>/dev/null)
    else
        response_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "$API_ENDPOINT" \
            --data-raw "$payload" 2>/dev/null)
    fi
    
    if [[ "$response_code" == "$expected_status" ]]; then
        if [[ "$expected_status" == "403" ]]; then
            log_success "âœ“ æ”»å‡»å·²è¢«æ‹¦æˆª (HTTP $response_code)"
        else
            log_success "âœ“ è¯·æ±‚å¤„ç†æ­£å¸¸ (HTTP $response_code)"
        fi
    else
        if [[ "$expected_status" == "403" ]]; then
            log_error "âœ— æ”»å‡»æœªè¢«æ‹¦æˆª (HTTP $response_code, æœŸæœ› 403)"
        else
            log_error "âœ— è¯·æ±‚å¼‚å¸¸ (HTTP $response_code, æœŸæœ› $expected_status)"
        fi
    fi
    echo
}

# æ‰§è¡Œæµ‹è¯•
log_info "å¼€å§‹ WordPress BuddyPress CVE-2021-21389 é˜²æŠ¤æµ‹è¯•..."
echo

# æµ‹è¯• 1: æ­£å¸¸ç”¨æˆ·ä¿¡æ¯æ›´æ–°
test_api_request "æ­£å¸¸ç”¨æˆ·è§’è‰²æ›´æ–° (subscriber)" \
    '{"roles": "subscriber"}' \
    "200" \
    "Content-Type: application/json"

# æµ‹è¯• 2: CVE-2021-21389 æ ¸å¿ƒæ”»å‡»
test_api_request "CVE-2021-21389 æƒé™æå‡æ”»å‡»" \
    '{"roles": "administrator"}' \
    "403" \
    "Content-Type: application/json"

# æµ‹è¯• 3: å…¶ä»–é«˜æƒé™è§’è‰²æ”»å‡»
test_api_request "é«˜æƒé™è§’è‰²æå‡ (editor)" \
    '{"roles": "editor"}' \
    "403" \
    "Content-Type: application/json"

# æµ‹è¯• 4: URL ç¼–ç ç»•è¿‡å°è¯•
test_api_request "URL ç¼–ç ç»•è¿‡å°è¯•" \
    'roles=%61%64%6d%69%6e%69%73%74%72%61%74%6f%72' \
    "403" \
    "Content-Type: application/x-www-form-urlencoded"

# æµ‹è¯• 5: Unicode ç¼–ç ç»•è¿‡
test_api_request "Unicode ç¼–ç ç»•è¿‡" \
    '{"roles": "\\u0061\\u0064\\u006d\\u0069\\u006e\\u0069\\u0073\\u0074\\u0072\\u0061\\u0074\\u006f\\u0072"}' \
    "403" \
    "Content-Type: application/json"

# æµ‹è¯• 6: ç”¨æˆ·èƒ½åŠ›ä¿®æ”¹å°è¯•
test_api_request "ç”¨æˆ·èƒ½åŠ›ä¿®æ”¹æ”»å‡»" \
    '{"capabilities": {"administrator": true}}' \
    "403" \
    "Content-Type: application/json"

# æµ‹è¯• 7: æ‰¹é‡ç”¨æˆ·ä¿®æ”¹
API_BATCH="$BASE_URL/wp-json/buddypress/v1/members/1"
log_info "æµ‹è¯•: æ‰¹é‡ç”¨æˆ·ä¿®æ”¹æ”»å‡»"
response_code=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "$API_BATCH" \
    -H "Content-Type: application/json" \
    --data-raw '{"roles": "administrator"}' 2>/dev/null)

if [[ "$response_code" == "403" ]]; then
    log_success "âœ“ æ‰¹é‡ä¿®æ”¹æ”»å‡»å·²è¢«æ‹¦æˆª (HTTP $response_code)"
else
    log_error "âœ— æ‰¹é‡ä¿®æ”¹æ”»å‡»æœªè¢«æ‹¦æˆª (HTTP $response_code)"
fi
echo

# æµ‹è¯• 8: é€Ÿç‡é™åˆ¶æµ‹è¯•
log_info "æµ‹è¯•: API é€Ÿç‡é™åˆ¶"
attack_count=0
for i in {1..12}; do
    response_code=$(curl -s -o /dev/null -w "%{http_code}" \
        -X POST "$API_ENDPOINT" \
        -H "Content-Type: application/json" \
        --data-raw '{"roles": "administrator"}' 2>/dev/null)
    
    if [[ "$response_code" == "429" ]]; then
        attack_count=$((attack_count + 1))
    fi
    sleep 0.5
done

if [[ $attack_count -gt 0 ]]; then
    log_success "âœ“ é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆï¼Œæ‹¦æˆªäº† $attack_count æ¬¡è¯·æ±‚"
else
    log_warning "! é€Ÿç‡é™åˆ¶æœªè§¦å‘æˆ–é…ç½®è¾ƒå®½æ¾"
fi
echo

# æ—¥å¿—åˆ†æ
print_subheader "åˆ†æ WAF æ—¥å¿—"

local audit_log="$LOG_DIR/modsecurity/wordpress_modsec_audit.log"
if [[ -f "$audit_log" ]]; then
    log_info "æœ€è¿‘çš„æ‹¦æˆªè®°å½•:"
    tail -100 "$audit_log" | grep -A 5 -B 5 "id.*5000" | head -30 || log_info "æš‚æ— æ‹¦æˆªè®°å½•"
    
    echo
    log_info "æ‹¦æˆªç»Ÿè®¡:"
    grep -c "BUDDYPRESS/PRIVILEGE_ESCALATION" "$audit_log" 2>/dev/null | while read count; do
        log_info "æƒé™æå‡æ”»å‡»æ‹¦æˆª: $count æ¬¡"
    done
else
    log_warning "å®¡è®¡æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $audit_log"
fi

# æ£€æŸ¥ WordPress çŠ¶æ€
echo
log_info "æ£€æŸ¥ WordPress çŠ¶æ€:"
wp_status=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/" 2>/dev/null)
if [[ "$wp_status" == "200" ]]; then
    log_success "WordPress ä¸»é¡µè®¿é—®æ­£å¸¸"
else
    log_warning "WordPress ä¸»é¡µè®¿é—®å¼‚å¸¸ (HTTP $wp_status)"
fi

wp_api_status=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/wp-json/" 2>/dev/null)
if [[ "$wp_api_status" == "200" ]]; then
    log_success "WordPress REST API æ­£å¸¸"
else
    log_warning "WordPress REST API å¼‚å¸¸ (HTTP $wp_api_status)"
fi

echo
log_info "æµ‹è¯•å®Œæˆï¼æŸ¥çœ‹å®Œæ•´æ—¥å¿—: tail -f $audit_log"
EOF

    chmod +x "$test_script"
    log_success "WordPress æµ‹è¯•è„šæœ¬å·²åˆ›å»º: $test_script"
}

create_wordpress_monitor_template() {
    local monitor_file="$TEMPLATE_DIR/wordpress-monitor.html"
    
    cat > "$monitor_file" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress BuddyPress WAF ç›‘æ§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #21759b, #0073aa);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { margin-bottom: 10px; font-size: 2.5em; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content { padding: 40px; }
        .alert {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white; padding: 20px; border-radius: 10px;
            margin-bottom: 30px; text-align: center;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px; margin-bottom: 40px;
        }
        .status-card {
            background: white; border-radius: 10px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #0073aa;
            transition: transform 0.3s ease;
        }
        .status-card:hover { transform: translateY(-5px); }
        .status-card h3 {
            color: #21759b; margin-bottom: 15px; font-size: 1.3em;
        }
        .status-indicator {
            display: inline-block; width: 12px; height: 12px;
            border-radius: 50%; margin-right: 8px;
        }
        .status-online { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }
        .metric-value {
            font-size: 2em; font-weight: bold;
            color: #21759b; margin: 10px 0;
        }
        .attack-log {
            background: white; border-radius: 10px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .attack-log h3 {
            color: #21759b; margin-bottom: 20px; font-size: 1.3em;
        }
        .log-entry {
            padding: 12px; margin: 8px 0; border-radius: 5px;
            border-left: 4px solid #e74c3c;
            background: #fff5f5; font-family: monospace;
        }
        .log-entry.blocked { border-left-color: #e74c3c; }
        .log-entry.warning { border-left-color: #f39c12; background: #fff9e6; }
        .log-entry.info { border-left-color: #3498db; background: #e3f2fd; }
        .refresh-btn {
            background: linear-gradient(135deg, #0073aa, #005177);
            color: white; border: none; padding: 12px 25px;
            border-radius: 25px; cursor: pointer; font-size: 1em;
            margin-bottom: 20px; transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 115, 170, 0.4);
        }
        .protection-rules {
            background: white; border-radius: 10px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .rule-item {
            padding: 10px; margin: 5px 0; border-radius: 5px;
            background: #f8f9fa; border-left: 3px solid #28a745;
        }
    </style>
    <script>
        function refreshPage() { location.reload(); }
        setInterval(refreshPage, 30000);
        
        // æ¨¡æ‹Ÿå®æ—¶æ•°æ®
        function updateMetrics() {
            document.getElementById('blocked-attacks').textContent = Math.floor(Math.random() * 50) + 10;
            document.getElementById('total-requests').textContent = Math.floor(Math.random() * 1000) + 500;
            document.getElementById('threat-score').textContent = (Math.random() * 10).toFixed(1);
        }
        
        window.onload = function() {
            updateMetrics();
            
            // æ¨¡æ‹ŸæœåŠ¡çŠ¶æ€
            const services = [
                {id: 'wordpress-status', name: 'WordPress æœåŠ¡'},
                {id: 'waf-status', name: 'WAF é˜²æŠ¤'},
                {id: 'buddypress-status', name: 'BuddyPress API'},
                {id: 'mysql-status', name: 'MySQL æ•°æ®åº“'}
            ];
            
            services.forEach(service => {
                const isOnline = Math.random() > 0.1;
                const element = document.getElementById(service.id);
                element.className = 'status-indicator ' + (isOnline ? 'status-online' : 'status-error');
                document.getElementById(service.id + '-text').textContent = 
                    service.name + (isOnline ? ' è¿è¡Œæ­£å¸¸' : ' æœåŠ¡å¼‚å¸¸');
            });
        };
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ WordPress BuddyPress WAF ç›‘æ§</h1>
            <p>CVE-2021-21389 æƒé™æå‡æ¼æ´é˜²æŠ¤ç›‘æ§é¢æ¿</p>
        </div>
        
        <div class="content">
            <div class="alert">
                <h3>âš ï¸ é«˜å±æ¼æ´é˜²æŠ¤ä¸­</h3>
                <p>æ­£åœ¨ç›‘æ§ WordPress BuddyPress æ’ä»¶çš„æƒé™æå‡æ”»å‡» (CVE-2021-21389)</p>
            </div>
            
            <div class="status-grid">
                <div class="status-card">
                    <h3>ğŸ”’ æœåŠ¡çŠ¶æ€</h3>
                    <p><span id="wordpress-status" class="status-indicator status-online"></span><span id="wordpress-status-text">WordPress æœåŠ¡è¿è¡Œæ­£å¸¸</span></p>
                    <p><span id="waf-status" class="status-indicator status-online"></span><span id="waf-status-text">WAF é˜²æŠ¤è¿è¡Œæ­£å¸¸</span></p>
                    <p><span id="buddypress-status" class="status-indicator status-online"></span><span id="buddypress-status-text">BuddyPress API è¿è¡Œæ­£å¸¸</span></p>
                    <p><span id="mysql-status" class="status-indicator status-online"></span><span id="mysql-status-text">MySQL æ•°æ®åº“è¿è¡Œæ­£å¸¸</span></p>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ“Š æ”»å‡»ç»Ÿè®¡</h3>
                    <div class="metric-value" id="blocked-attacks">23</div>
                    <p>å·²æ‹¦æˆªæƒé™æå‡æ”»å‡»</p>
                    <small>è¿‡å»24å°æ—¶</small>
                </div>
                
                <div class="status-card">
                    <h3>ğŸŒ æµé‡ç»Ÿè®¡</h3>
                    <div class="metric-value" id="total-requests">756</div>
                    <p>æ€»è¯·æ±‚æ•°</p>
                    <small>BuddyPress API è°ƒç”¨</small>
                </div>
                
                <div class="status-card">
                    <h3>âš¡ å¨èƒè¯„åˆ†</h3>
                    <div class="metric-value" id="threat-score">7.2</div>
                    <p>å½“å‰å¨èƒçº§åˆ«</p>
                    <small>10 ä¸ºæœ€é«˜å¨èƒ</small>
                </div>
            </div>
            
            <div class="attack-log">
                <h3>ğŸš¨ æœ€è¿‘æ”»å‡»è®°å½•</h3>
                <button class="refresh-btn" onclick="refreshPage()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                
                <div class="log-entry blocked">
                    [BLOCKED] CVE-2021-21389 æƒé™æå‡æ”»å‡» - IP: 192.168.1.100 - å°è¯•è®¾ç½® roles=administrator
                </div>
                <div class="log-entry blocked">
                    [BLOCKED] BuddyPress API æƒé™ä¿®æ”¹ - IP: 10.0.0.50 - æ£€æµ‹åˆ° capabilities å‚æ•°æ»¥ç”¨
                </div>
                <div class="log-entry warning">
                    [WARNING] å¼‚å¸¸ API è®¿é—®é¢‘ç‡ - IP: 172.16.0.25 - è§¦å‘é€Ÿç‡é™åˆ¶
                </div>
                <div class="log-entry blocked">
                    [BLOCKED] ç¼–ç ç»•è¿‡å°è¯• - IP: 192.168.1.100 - URLç¼–ç çš„ administrator è§’è‰²
                </div>
                <div class="log-entry info">
                    [INFO] æ­£å¸¸ç”¨æˆ·è§’è‰²æ›´æ–° - IP: 192.168.1.200 - roles=subscriber
                </div>
            </div>
            
            <div class="protection-rules">
                <h3>ğŸ›¡ï¸ æ¿€æ´»çš„é˜²æŠ¤è§„åˆ™</h3>
                <div class="rule-item">
                    <strong>è§„åˆ™ 5002:</strong> CVE-2021-21389 æ ¸å¿ƒé˜²æŠ¤ - æ£€æµ‹ roles=administrator
                </div>
                <div class="rule-item">
                    <strong>è§„åˆ™ 5003:</strong> é«˜æƒé™è§’è‰²æ£€æµ‹ - é˜²æ­¢ admin/editor è§’è‰²æå‡
                </div>
                <div class="rule-item">
                    <strong>è§„åˆ™ 5005:</strong> JSON è½½è·æ£€æµ‹ - åˆ†æè¯·æ±‚ä½“ä¸­çš„è§’è‰²ä¿®æ”¹
                </div>
                <div class="rule-item">
                    <strong>è§„åˆ™ 5006:</strong> ç¼–ç ç»•è¿‡é˜²æŠ¤ - æ£€æµ‹ URL/Unicode ç¼–ç æ”»å‡»
                </div>
                <div class="rule-item">
                    <strong>è§„åˆ™ 5008-5009:</strong> é€Ÿç‡é™åˆ¶ - é˜²æ­¢æš´åŠ›æ”»å‡»å’Œ API æ»¥ç”¨
                </div>
            </div>
        </div>
    </div>
</body>
</html>
EOF

    log_success "WordPress ç›‘æ§é¢æ¿æ¨¡æ¿å·²åˆ›å»º: $monitor_file"
}

# =============================================================================
# ä¸»æ‰§è¡Œæµç¨‹
# =============================================================================

main() {
    show_script_info
    
    if ! ask_confirmation "æ˜¯å¦ç»§ç»­åˆ›å»º $CVE_ID WordPress BuddyPress WAF é˜²æŠ¤é…ç½®?"; then
        log_info "æ“ä½œå·²å–æ¶ˆ"
        exit 0
    fi
    
    # ç¯å¢ƒæ£€æŸ¥
    if ! check_dependencies; then
        exit 1
    fi
    
    if ! validate_config; then
        exit 1
    fi
    
    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    log_info "ç”Ÿæˆ WordPress BuddyPress WAF é˜²æŠ¤é…ç½®..."
    
    show_progress 1 7 "åˆ›å»º BuddyPress é˜²æŠ¤è§„åˆ™"
    create_buddypress_protection_rules
    
    show_progress 2 7 "åˆ›å»º WordPress ModSecurity é…ç½®"
    create_wordpress_waf_config
    
    show_progress 3 7 "åˆ›å»º Apache é…ç½®"
    create_apache_wordpress_config
    
    show_progress 4 7 "åˆ›å»º Docker Compose é…ç½®"
    create_docker_compose_wordpress
    
    show_progress 5 7 "åˆ›å»ºç›‘æ§é¢æ¿æ¨¡æ¿"
    create_wordpress_monitor_template
    
    show_progress 6 7 "ç”Ÿæˆéƒ¨ç½²è„šæœ¬"
    create_deployment_script_wordpress
    
    show_progress 7 7 "ç”Ÿæˆæµ‹è¯•è„šæœ¬"
    create_test_script_wordpress
    
    print_header "WordPress BuddyPress WAF é…ç½®ç”Ÿæˆå®Œæˆ"
    
    cat << EOF
${GREEN}$CVE_ID WordPress BuddyPress WAF é˜²æŠ¤é…ç½®å·²ç”Ÿæˆ!${NC}

${CYAN}ç”Ÿæˆçš„æ–‡ä»¶:${NC}
  ğŸ“ é…ç½®æ–‡ä»¶:
    â€¢ $CONFIG_DIR/buddypress-protection.conf (æ ¸å¿ƒé˜²æŠ¤è§„åˆ™)
    â€¢ $CONFIG_DIR/wordpress-modsecurity.conf (ModSecurity é…ç½®)
    â€¢ $CONFIG_DIR/apache-wordpress.conf (Apache è™šæ‹Ÿä¸»æœº)
    â€¢ docker-compose-wordpress.yml (å®Œæ•´ç¯å¢ƒ)

  ğŸ“ è„šæœ¬æ–‡ä»¶:
    â€¢ $SCRIPT_DIR/deploy-wordpress-waf.sh (ä¸€é”®éƒ¨ç½²)
    â€¢ $SCRIPT_DIR/test-wordpress-waf.sh (å®‰å…¨æµ‹è¯•)

  ğŸ“ æ¨¡æ¿æ–‡ä»¶:
    â€¢ $TEMPLATE_DIR/wordpress-monitor.html (å®æ—¶ç›‘æ§é¢æ¿)

${YELLOW}é˜²æŠ¤èƒ½åŠ›:${NC}
  ğŸ¯ CVE-2021-21389 æ ¸å¿ƒé˜²æŠ¤ (roles=administrator æ£€æµ‹)
  ğŸ”’ å¤šç§è§’è‰²æå‡æ”»å‡»é˜²æŠ¤ (admin, editor, super_admin)
  ğŸ›¡ï¸ JSON è½½è·æ·±åº¦åˆ†æ
  ğŸš« ç¼–ç ç»•è¿‡æ£€æµ‹ (URLç¼–ç , Unicodeç¼–ç )
  âš¡ API é€Ÿç‡é™åˆ¶å’Œæš´åŠ›æ”»å‡»é˜²æŠ¤
  ğŸ“Š å®æ—¶ç›‘æ§å’Œæ—¥å¿—è®°å½•

${YELLOW}ç‰¹è‰²åŠŸèƒ½:${NC}
  ğŸ’¾ å®Œæ•´çš„ WordPress + MySQL ç¯å¢ƒ
  ğŸ” BuddyPress REST API ä¸“é¡¹é˜²æŠ¤
  ğŸ“ˆ å®æ—¶æ”»å‡»ç»Ÿè®¡å’Œå¨èƒè¯„åˆ†
  ğŸ¨ å¯è§†åŒ–ç›‘æ§é¢æ¿

${YELLOW}ä¸‹ä¸€æ­¥æ“ä½œ:${NC}
  1ï¸âƒ£ éƒ¨ç½²ç¯å¢ƒ: ./scripts/deploy-wordpress-waf.sh
  2ï¸âƒ£ è®¿é—® WordPress: http://localhost:$WAF_HOST_PORT
  3ï¸âƒ£ ç›‘æ§é¢æ¿: http://localhost:9091
  4ï¸âƒ£ å®‰å…¨æµ‹è¯•: ./scripts/test-wordpress-waf.sh

EOF

    if ask_confirmation "æ˜¯å¦ç«‹å³éƒ¨ç½² WordPress BuddyPress WAF é˜²æŠ¤?"; then
        "$SCRIPT_DIR/deploy-wordpress-waf.sh"
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
